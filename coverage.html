test
mongodb://127.0.0.1:27017/field_guide_app_test
listening on 8080
{ user: null, password: null }
{ email: 'becky@made.com', name: 'becky', password: 'becky' }
{ email: 'login@heistmade.com',
  name: 'becky',
  password: 'becky' }
{ email: 'sarah@made.com', name: 'sarah', password: 'sarah' }
<!DOCTYPE html><html><head><title>Coverage</title><meta charset="utf-8"><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style>
</head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov high">100</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/config/auth.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/config/</span><span class="basename">auth.js</span></a></li><li><span class="cov high">75</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/config/db.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/config/</span><span class="basename">db.js</span></a></li><li><span class="cov high">93</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/config/environment-test.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/config/</span><span class="basename">environment-test.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/config/passport-new-user.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/config/</span><span class="basename">passport-new-user.js</span></a></li><li><span class="cov low">46</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/config/passport.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/config/</span><span class="basename">passport.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/secrets.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/</span><span class="basename">secrets.js</span></a></li><li><span class="cov high">97</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/</span><span class="basename">server.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/auth/invitation.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/auth/</span><span class="basename">invitation.js</span></a></li><li><span class="cov high">88</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/auth/user.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/auth/</span><span class="basename">user.js</span></a></li><li><span class="cov medium">66</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/comment.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/</span><span class="basename">comment.js</span></a></li><li><span class="cov medium">66</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/message.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/</span><span class="basename">message.js</span></a></li><li><span class="cov medium">61</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/subject.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/</span><span class="basename">subject.js</span></a></li><li><span class="cov medium">72</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/tag.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/</span><span class="basename">tag.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/task.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/</span><span class="basename">task.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/test.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/</span><span class="basename">test.js</span></a></li><li><span class="cov terrible">14</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/add-subject.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">add-subject.js</span></a></li><li><span class="cov terrible">5</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/build-object-list.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">build-object-list.js</span></a></li><li><span class="cov terrible">14</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/build-summary.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">build-summary.js</span></a></li><li><span class="cov terrible">14</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/comment.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">comment.js</span></a></li><li><span class="cov terrible">6</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/create-invite.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">create-invite.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/default-tests.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">default-tests.js</span></a></li><li><span class="cov terrible">7</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/delete-task.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">delete-task.js</span></a></li><li><span class="cov terrible">8</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/delete-test.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">delete-test.js</span></a></li><li><span class="cov terrible">3</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/dev-tests.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">dev-tests.js</span></a></li><li><span class="cov terrible">5</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/dupe-tests.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">dupe-tests.js</span></a></li><li><span class="cov terrible">4</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/edit-message.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">edit-message.js</span></a></li><li><span class="cov terrible">9</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/edit-test.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">edit-test.js</span></a></li><li><span class="cov terrible">16</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/message-fav.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">message-fav.js</span></a></li><li><span class="cov low">33</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/messages-list.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">messages-list.js</span></a></li><li><span class="cov terrible">5</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/new-message.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">new-message.js</span></a></li><li><span class="cov terrible">6</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/object-updates.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">object-updates.js</span></a></li><li><span class="cov terrible">11</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/resend-invite.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">resend-invite.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/user-create.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/</span><span class="basename">user-create.js</span></a></li><li><span class="cov low">48</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/models/mailer.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/models/</span><span class="basename">mailer.js</span></a></li><li><span class="cov medium">51</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/</span><span class="basename">routes.js</span></a></li><li><span class="cov low">35</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/account.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">account.js</span></a></li><li><span class="cov medium">58</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/message.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">message.js</span></a></li><li><span class="cov medium">66</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/run.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">run.js</span></a></li><li><span class="cov low">37</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/subject.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">subject.js</span></a></li><li><span class="cov low">29</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/summary.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">summary.js</span></a></li><li><span class="cov low">41</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/tag.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">tag.js</span></a></li><li><span class="cov low">29</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/task.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">task.js</span></a></li><li><span class="cov low">35</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/test.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">test.js</span></a></li><li><span class="cov low">26</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/routes/user.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/</span><span class="basename">user.js</span></a></li><li><span class="cov low">25</span><a href="#/Users/alexleitch/Documents/Heist/scout-dev/server/socket_routes_09.js"><span class="dirname">/Users/alexleitch/Documents/Heist/scout-dev/server/</span><span class="basename">socket_routes_09.js</span></a></li><a id="logo" href="http://visionmedia.github.io/mocha/">m</a></div><div id="stats" class="low"><div class="percentage">38%</div><div class="sloc">1161</div><div class="hits">452</div><div class="misses">709</div></div><div id="files"><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/config/auth.js">/Users/alexleitch/Documents/Heist/scout-dev/config/auth.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">3</div><div class="hits">3</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// config/auth.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">// expose our config directly to our application using module.exports</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(app){</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">    var authObj = {</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        'trelloAuth' : {</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">                'clientID'  : '3db0f3dee26d4be56033d04b47c53e7b',</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">                'clientSecret' : 'dcc5e3171042186dc7ff33a947acae806d73ab2993a7c8be2701fb48157b96bc',</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">                'callbackURL'  : 'http://'+app.locals.real_url+'/connect/trello/callback'</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    return authObj;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/config/db.js">/Users/alexleitch/Documents/Heist/scout-dev/config/db.js</h2><div id="stats" class="high"><div class="percentage">75%</div><div class="sloc">16</div><div class="hits">12</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// db.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// database configuration and environment sniffing parcel</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var environment = require('../config/environment-test');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// reminder: this is local because it's local to _the server_</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">// server's always gon' be local to the code</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">if(environment() !== 'test'){</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">	var mongoUrl = process.env.MONGOLAB_URI || 'mongodb://127.0.0.1:27017/field_guide_app';</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">	var db = mongoose.createConnection(mongoUrl);</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">	var auth_db = db.useDb('field_guide_users');</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">	console.log(mongoUrl);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">	</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">else {</td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">	console.log(environment());</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">	var mongoUrl = process.env.MONGOLAB_URI || 'mongodb://127.0.0.1:27017/field_guide_app_test';</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">	var db = mongoose.createConnection(mongoUrl);</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">	var auth_db = db.useDb('field_guide_users_test');</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">	</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">	console.log(mongoUrl);</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">module.exports = {auth: auth_db, db: db};</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">// this segment does not work right now.</td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">	db.on('error', console.error.bind(console, 'connection error:'));</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">	db.once('open', function callback () {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">	         // yay!</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">	});</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/config/environment-test.js">/Users/alexleitch/Documents/Heist/scout-dev/config/environment-test.js</h2><div id="stats" class="high"><div class="percentage">93%</div><div class="sloc">16</div><div class="hits">15</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// environment-test.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// a small function to find an environment and return it by ip.address</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(){</td></tr><tr class="hit"><td class="line">6</td><td class="hits">2</td><td class="source">	var net = require('os').networkInterfaces();</td></tr><tr class="hit"><td class="line">7</td><td class="hits">2</td><td class="source">	var list = function(ifaces){</td></tr><tr class="hit"><td class="line">8</td><td class="hits">2</td><td class="source">		var address;</td></tr><tr class="hit"><td class="line">9</td><td class="hits">2</td><td class="source">		Object.keys(ifaces).forEach(function (ifname) {</td></tr><tr class="hit"><td class="line">10</td><td class="hits">4</td><td class="source">			var alias = 0;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">4</td><td class="source">			ifaces[ifname].forEach(function (iface) {</td></tr><tr class="hit"><td class="line">13</td><td class="hits">10</td><td class="source">				if ('IPv4' !== iface.family || iface.internal !== false) {</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">				// skip over internal (i.e. 127.0.0.1) and non-ipv4 addresses</td></tr><tr class="hit"><td class="line">15</td><td class="hits">8</td><td class="source">					return;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">				}</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">2</td><td class="source">				if (alias &gt;= 1) {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">				// this single interface has multiple ipv4 addresses</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">					// console.log(ifname + ':' + alias, iface.address);</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">					address = iface.address;</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">				} else {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">				// this interface has only one ipv4 adress</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">					// console.log(ifname, iface.address);</td></tr><tr class="hit"><td class="line">26</td><td class="hits">2</td><td class="source">					address = iface.address;</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">				}</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">			});</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">		});</td></tr><tr class="hit"><td class="line">30</td><td class="hits">2</td><td class="source">		return address;</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">	};</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">	</td></tr><tr class="hit"><td class="line">33</td><td class="hits">2</td><td class="source">	var str = list(net).split('.');</td></tr><tr class="hit"><td class="line">34</td><td class="hits">2</td><td class="source">	return (str[0].length &gt; 2) ? 'production' : 'test';</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/config/passport-new-user.js">/Users/alexleitch/Documents/Heist/scout-dev/config/passport-new-user.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">14</div><div class="hits">14</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// passport-new-user.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// passport user creation function</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports =  function(user, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module Dependencies</td></tr><tr class="hit"><td class="line">7</td><td class="hits">3</td><td class="source">    var async = require('async');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// load required models</td></tr><tr class="hit"><td class="line">10</td><td class="hits">3</td><td class="source">    var User = require('../server/models/auth/user');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// load required functions</td></tr><tr class="hit"><td class="line">13</td><td class="hits">3</td><td class="source">    var newUser = require('../server/models/functions/user-create');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">// Check if a user by that e-mail already exists, or create a new user.</td></tr><tr class="hit"><td class="line">16</td><td class="hits">3</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="hit"><td class="line">18</td><td class="hits">3</td><td class="source">          User.findOne({ 'local.email' : user.email })</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            .exec(function(err, doc) {</td></tr><tr class="hit"><td class="line">20</td><td class="hits">3</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="hit"><td class="line">21</td><td class="hits">3</td><td class="source">                var call = (doc !== null ) ? 'That email is already taken.' : null ;</td></tr><tr class="hit"><td class="line">22</td><td class="hits">3</td><td class="source">                callback(null, call);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        function(arg, callback){</td></tr><tr class="hit"><td class="line">26</td><td class="hits">4</td><td class="source">            if(arg !== null ){ callback(null, arg); }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            else {</td></tr><tr class="hit"><td class="line">28</td><td class="hits">2</td><td class="source">                newUser(user, function(err, doc){</td></tr><tr class="hit"><td class="line">29</td><td class="hits">2</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="hit"><td class="line">30</td><td class="hits">2</td><td class="source">                    callback(null, doc);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        }], next);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/config/passport.js">/Users/alexleitch/Documents/Heist/scout-dev/config/passport.js</h2><div id="stats" class="low"><div class="percentage">46%</div><div class="sloc">50</div><div class="hits">23</div><div class="misses">27</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// config/passport.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">// expose this function to our app using module.exports</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(app, passport) {</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    // load all the things we need</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">    var LocalStrategy   = require('passport-local').Strategy;</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var TrelloStrategy = require('passport-trello').Strategy;</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var bcrypt = require('bcrypt-nodejs');</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var async = require('async');</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var mongoose = require('mongoose');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    // load up the user model</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var User = require('../server/models/auth/user');</td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var Invitation = require('../server/models/auth/invitation');</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var passportNewUser = require('../config/passport-new-user');</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    // load the auth variables</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var configAuth = require('./auth')(app);</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    // =========================================================================</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    // passport session setup ==================================================</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    // =========================================================================</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    // required for persistent login sessions</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    // passport needs ability to serialize and unserialize users out of session</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    // used to serialize the user for the session</td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">    passport.serializeUser(function(user, done) {</td></tr><tr class="hit"><td class="line">30</td><td class="hits">2</td><td class="source">        done(null, user.id);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    // used to deserialize the user</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    passport.deserializeUser(function(id, done) {</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        User.findById(id, function(err, user) {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            // console.log('serialized user?', user);</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">            done(err, user);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">// =========================================================================</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">// LOCAL LOGIN =============================================================</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">// =========================================================================</td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">    passport.use('local-login', new LocalStrategy({</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        // by default, local strategy uses username and password, we will override with email</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        usernameField : 'email',</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        passwordField : 'password',</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        passReqToCallback : true // allows us to pass in the req from our route (lets us check if a user is logged in or not)</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    }, function(req, email, password, done) {</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">        if (email) {email = email.toLowerCase();} // Use lower-case e-mails to avoid case-sensitive e-mail matching</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        // asynchronous</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">        process.nextTick(function() {</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">            User.findOne({ 'local.email' :  email }, function(err, user) {</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                // if there are any errors, return the error</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                if (err)</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">                    {return done(err);}</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                // if no user is found, return the message</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                if (!user)</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">                    {return done(null, { error: 'No user found. ' });}</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">                if (!user.validPassword(password))</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">                    {return done(null, { error: 'Oops! Wrong password.' });}</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                // all is well, return user</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">                    {return done(null, user);}</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    }));</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">// =========================================================================</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">// LOCAL SIGNUP ============================================================</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">// =========================================================================</td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">    function generateHash(password) { return bcrypt.hashSync(password, bcrypt.genSaltSync(8), null); }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">    passport.use('local-signup', new LocalStrategy({</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            // by default, local strategy uses username and password, we will override with email</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            usernameField : 'email',</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            passwordField : 'password',</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            passReqToCallback : true // allows us to pass in the req from our route (lets us check if a user is logged in or not)</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        function(req, email, password, done){</td></tr><tr class="hit"><td class="line">85</td><td class="hits">3</td><td class="source">            if (req.user){ return done(null, 'Please log out before signing up again.'); } </td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">            </td></tr><tr class="hit"><td class="line">87</td><td class="hits">3</td><td class="source">            var user = {</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">                name : req.body.name,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                email : email ? email.toLowerCase() : '' , // Use lower-case e-mails to avoid case-sensitive e-mail matching</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                password : password,</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                invite: req.body.invite || ''</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">94</td><td class="hits">3</td><td class="source">            passportNewUser(user, function(err, next){</td></tr><tr class="hit"><td class="line">95</td><td class="hits">3</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="hit"><td class="line">96</td><td class="hits">3</td><td class="source">                done(null, next);</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    );</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">// =========================================================================</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">// TRELLO AUTHORIZATION ====================================================</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">// =========================================================================</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">105</td><td class="hits">1</td><td class="source">    passport.use('trello-authz', new TrelloStrategy({</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        consumerKey: configAuth.trelloAuth.clientID,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        consumerSecret: configAuth.trelloAuth.clientSecret,</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        callbackURL: configAuth.trelloAuth.callbackURL,</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        passReqToCallback: true, // we are not using trello to log in to our app.</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        trelloParams: {</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                scope: &quot;read,write&quot;,</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                name: &quot;Field Guide&quot;,</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                expiration: &quot;never&quot;</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        }, </td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    function(req, token, tokenSecret, profile, done) {</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">            console.log('touched passport trello');</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">            if (!req.user) {</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">                console.log('nope! the user is not logged in');</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">                var reply = 'Sorry, that user is not logged in to Field Guide.';</td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="source">                return done(null, reply);</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">            } else {</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="source">                console.log('yep, looks like someone is logged in', req.user.id);</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">                User.findById(req.user.id)</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                .exec(function(err, user) {</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">                    if (err) { return done(err); }</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                    console.log('gotcha,', user._id);</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">                    user.trello.id = profile.id;</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">                    user.trello.token = token;</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">                    user.trello.tokenSecret = tokenSecret;</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="source">                    user.save(function(err,data){</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                    // pass the user back to routes.js</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">                        console.log('user saved');</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">                        return done(null, data);</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">        }));</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/secrets.js">/Users/alexleitch/Documents/Heist/scout-dev/secrets.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">1</div><div class="hits">1</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// secrets.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// nodemon server --watch /public --watch /server</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var config_data = module.exports = {</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">    // app.locals.real_url = 'app.fieldguide.com'; // THIS IS FOR EMAILS</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    // real_url = process.env.FIELD_GUIDE_BASEURL || '104.236.16.159:'+port,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    secret: '$2a$10$Zl85yFNH6JVtlF0thUHete0BH80QbOpGw0lMJmN86mI8tnejLHKE4NrAUVgEtpUdOjMOXC3F9dW35FXI7TybjxnQ6tQl5UmOiNcqXg4Uz9QG67hXAY2G5At1yaBtvcEFeYVUnsKLW2aHU5VRT1FjMlIF07220mBhkCOZ6GgWDz48DcDwowNHKelzHqvpIy8tyBl3GYBK2h6FT8xiGRddV49pFRmCSRlKZOoBQuNQlvcTIC3JpRHFWW1V2NHCxjWfrEzZvYauyhkR0MZ1oNFiDPB8TdrWxPJph2j6U3aBqHlyrCP3Ty70jqAdxCCuAbCLfF9Csf2pViqOvwJqIObR4ZNhZCfdsNn9KcNMRLCEZ6OuqO1tKuI5tsz5Ax4bo96EMjSuSmJeO07YY40W2G9JmOyIpRTlOcvPUZFmkrkQwhpEDNvRE9bAh7fauXP8AQWS1Rl0EZQ3Yg1qVnCf9snkZoBdY2UCxrDDLLjyxL5xojvpELZvMxHPiqTp99SRz8St3aoc0mGPxAOx5ykFoMfzQ98Zdknk8CU5LQkfoKhSQIxqUcOmUZx',</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    cookie_name: 'connect.sid',</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    stripeSecret: 'sk_test_IaKQLgGmIQ4mDatJVhOlmVw4',</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    mandrillSecret: 'bMsKb-GUxBkpBbIBJ4XW4g'</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server.js">/Users/alexleitch/Documents/Heist/scout-dev/server.js</h2><div id="stats" class="high"><div class="percentage">97%</div><div class="sloc">42</div><div class="hits">41</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// server.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">// modules ==========================================================</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var express = require('express');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var app = express();</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var http = require('http');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var path = require('path');</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">var _ = require('lodash');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">var async = require('async');</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var debug = require('debug')('http');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// Turn the app on and hook sockets 0.9 to it.</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">var server = http.createServer(app);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">var passport = require('passport');</td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">var cors = require('cors');</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">// EXPRESS MODULES ==================================================</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">var logger       = require('morgan');</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">var cookieParser = require('cookie-parser');</td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">var bodyParser   = require('body-parser');</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">var session      = require('express-session');</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">// SESSION STORAGE ==================================================</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">var session = require('express-session');</td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">var MongoStore = require('connect-mongo')(session);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">// PROCESS PORTS =====================================================</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">var port = Number(process.env.FIELD_GUIDE_PORT || process.env.PORT || 8080);</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">// var port = Number(process.env.FIELD_GUIDE_PORT || 80);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">// GLOBAL VARIABLES =================================================</td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">var secrets = require(path.join(__dirname,'secrets'));</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">app.locals = _.merge(app.locals, secrets);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">// CONFIGURATION ====================================================</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">app.use(cors()); // permit cross-site requests, ie: passport.</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">global.rootRequire = function(name) {</td></tr><tr class="hit"><td class="line">42</td><td class="hits">45</td><td class="source">    return require(__dirname + '/' + name);</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">// express 4.0 basic configuration ==================================</td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">app.use(cookieParser());</td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">app.use(express.static(__dirname + '/public'));</td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">app.use(bodyParser());</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">// passport configuration ===========================================</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">require('./config/passport')(app, passport);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">// Database summoning ===============================================</td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">var database = require('./config/db');</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">var db = database.db;</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">var auth_db = database.auth_db;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">// session start ====================================================</td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">app.locals.store = new MongoStore({'db': 'sessions'});</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">app.use(session({</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">	secret: app.locals.secret, </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">	cookie: {</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">		path: '/',</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">		expires: false, // Alive Until Browser Exits</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">		// secure: true, // TODO: implement https</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">		httpOnly: true</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">	},</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">	store: app.locals.store</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">}));</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">app.use(passport.initialize());</td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">app.use(passport.session()); // persistent login sessions</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">// server /api/ routes ==============================================</td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">var router = require('./server/routes')(app, passport, debug);</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">// DEFAULT ROUTE ====================================================</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">// Prevents the ENOENT rendering error</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">81</td><td class="hits">1</td><td class="source">app.get('*', function(req, res) {</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">			res.sendfile(__dirname + '/public/index.html');</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">		});</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">// SOCKET.IO ========================================================</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">// lives after normal routes, is dynamic routes accessed separately</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">// has its own auth functions</td></tr><tr class="hit"><td class="line">88</td><td class="hits">1</td><td class="source">var io = require('socket.io').listen(server, {log : false});</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">// socket 0.9 in use to speak to Field Guide App</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">require('./server/socket_routes_09')(io, app, passport, debug);</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">// Turn it on. </td></tr><tr class="hit"><td class="line">93</td><td class="hits">2</td><td class="source">server.listen(port, function(){ console.log('listening on', port);});</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">// EXPOSE APP AS OBJECT =============================================</td></tr><tr class="hit"><td class="line">96</td><td class="hits">1</td><td class="source">exports = module.exports = app;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/auth/invitation.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/auth/invitation.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">12</div><div class="hits">12</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// server/models/data/invitation.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">// Lives in the auth database, called field_guide_users</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">// ID of invitation and _account get passed with the invitation</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// When a user clicks on an invite link, and goes to register, if they are already registered,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Pending is set to false and we offer a password reset link</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// Invitations are how we get new users into the system.</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var connect = rootRequire('./config/db');</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">connect = connect.auth;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">var Schema = mongoose.Schema;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">var inviteSchema = new Schema({</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    _account : { type: Schema.Types.ObjectId },</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    invite_email: { type: String, trim: true },</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    created : { type : Date },</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    created_by_user : { type: Schema.Types.ObjectId, ref: 'User' },</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    pending : {type: Boolean, default: true}</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">inviteSchema.pre('save', function(next){</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    // set up the date</td></tr><tr class="hit"><td class="line">30</td><td class="hits">2</td><td class="source">    var now = new Date();</td></tr><tr class="hit"><td class="line">31</td><td class="hits">2</td><td class="source">    if ( !this.created ) {</td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">        this.created = now;</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">34</td><td class="hits">2</td><td class="source">    next();</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">module.exports = connect.model('Invitation', inviteSchema);</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/auth/user.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/auth/user.js</h2><div id="stats" class="high"><div class="percentage">88%</div><div class="sloc">18</div><div class="hits">16</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// server/models/auth/user.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// controls user accounts</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var connect = rootRequire('./config/db');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">connect = connect.auth;</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">var bcrypt = require('bcrypt-nodejs');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">var Schema = mongoose.Schema;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// Users are the people who log in to our system to use it.</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// They live on a separate DB from data.</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">// This DB is also where we store invitations.</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">var userSchema = new Schema({</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    _account: {type: Schema.Types.ObjectId},</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    _invite : {type: Schema.Types.ObjectId},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    onboarding: {type: Boolean , default : true}, </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    name: {type:String, trim:true},</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    onboard : {type: Number, default: 1},</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    resetPasswordToken: String,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    resetPasswordExpires: Date,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    local            : {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        email        : String,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        password     : String,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        name         : String</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    trello           : {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        id           : String,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        token        : String,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        tokenSecret  : String</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    github           : {</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        id           : String,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        token        : String,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        tokenSecret  : String</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    google           : {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        id           : String,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        token        : String,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        email        : String,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        name         : String</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">// generating a hash</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">userSchema.statics.generateHash = function(password, callback) {</td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">    var pass = bcrypt.hashSync(password, bcrypt.genSaltSync(8), null);</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    callback(null, pass);</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">// checking if password is valid</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">userSchema.statics.validPassword = function(password) {</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">    return bcrypt.compareSync(password, this.local.password);</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">// if a user's shared account key does not exist, create an account key.</td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">userSchema.pre('save', function(next){</td></tr><tr class="hit"><td class="line">63</td><td class="hits">3</td><td class="source">    var account = mongoose.Types.ObjectId();</td></tr><tr class="hit"><td class="line">64</td><td class="hits">3</td><td class="source">    if ( !this._account ) {</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        // if this user is a new user with no account.... </td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">        this._account = account;</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">68</td><td class="hits">3</td><td class="source">    next();</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">// create the model for users and expose it to our app</td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">module.exports = connect.model('User', userSchema);</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/comment.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/comment.js</h2><div id="stats" class="medium"><div class="percentage">66%</div><div class="sloc">12</div><div class="hits">8</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">//  comment.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Schema = mongoose.Schema;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var connect = rootRequire('./config/db');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var db = connect.db;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">// Comments are Message sub-documents.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">// They are summoned and related to specific messages in the Reports.</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var CommentSchema = new Schema ({</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    body : { type: String, trim: true },</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    created_by_user : { type: Schema.Types.ObjectId },</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    name : { type: String, trim: true },</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    created: Date</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">CommentSchema.pre('save', function(next){</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">    var now = new Date();</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    if ( !this.created ) {</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        this.created = now;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">module.exports = db.model('Comment', CommentSchema);</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/message.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/message.js</h2><div id="stats" class="medium"><div class="percentage">66%</div><div class="sloc">12</div><div class="hits">8</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">//  message.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Schema = mongoose.Schema;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var connect = rootRequire('./config/db');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var db = connect.db;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">// Messages are the basic unit of information in Field Guide.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">// They are currently associated to Tasks and Tags (themes)</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// But are soon to be associated to only Themes. </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">// Messages are made by Users in association with Subjects.</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">// They are not a sub-document of Subjects because they are sometimes </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">// independent of that Subject.</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">var MessageSchema = new Schema ({</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    _subject : { type: Schema.Types.ObjectId, ref: 'Subject' },</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    _test : { type: Schema.Types.ObjectId, ref: 'Test' },</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    _task : { type: Schema.Types.ObjectId, ref: 'Task' },</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    _comments : [{ type: Schema.Types.ObjectId, ref: 'Comment' }],</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    body : { type: String, trim: true },</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    created_by_user : { type: Schema.Types.ObjectId },</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    fav_task : { type: Boolean, default: true },</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    fav_tag : { type: Boolean, default: true },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    created: Date</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">MessageSchema.pre('save', function(next){</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">  var now = new Date();</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">  if ( !this.created ) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">    this.created = now;</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">  }</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">  next();</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">module.exports = db.model('Message', MessageSchema);</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/subject.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/subject.js</h2><div id="stats" class="medium"><div class="percentage">61%</div><div class="sloc">13</div><div class="hits">8</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">//  subject.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Schema = mongoose.Schema;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var connect = rootRequire('./config/db');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var db = connect.db;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">// Subjects are the basic unit of a Test.</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// A Subject has a bunch of messages associated with them</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// Along with what test/tests they've taken.</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">// Subjects are not expected to be unique within the system as of yet.</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">var SubjectSchema = new Schema ({</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    _tests : [{ type: Schema.Types.ObjectId, ref: 'Test' }],</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    _messages: [{ type: Schema.Types.ObjectId, ref: 'Message' }],</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    name: {type:String, trim:true},</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    test: { type: Schema.Types.ObjectId, ref: 'Test' },</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    testroom : {type:String, trim:true},</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    created : Date,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    updated : Date</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">SubjectSchema.pre('save', function(next){</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">    var now = new Date();</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">    this.updated = now;</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    if ( !this.created ) {</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        this.created = now;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">module.exports = db.model('Subject', SubjectSchema);</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/tag.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/tag.js</h2><div id="stats" class="medium"><div class="percentage">72%</div><div class="sloc">11</div><div class="hits">8</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">//  tag.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Schema = mongoose.Schema;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var connect = rootRequire('./config/db');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var db = connect.db;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">// TODO: Tags are eventually themes, which store all our messages.</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var TagSchema = new Schema({</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    _tasks     : [{ type: Schema.Types.ObjectId, ref: 'Task'}],</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    _messages: [{ type: Schema.Types.ObjectId, ref: 'Message'}],</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    _test      : {  type: Schema.Types.ObjectId, ref: 'Test'},</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    doctype : { type: String, trim: true, default: 'tag' },</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    // body: { type : String, trim : true },</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    name: { type : String, trim : true },</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    summary: { type : String, trim : true },</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    embed   : { type: String, default: '' },</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    index: Number,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    report_index: Number,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    visible: { type:Boolean, default: true },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    summarized : { type:Boolean, default:false }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">TagSchema.pre('save', function(next){</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    if(this.summary){</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        this.summarized = true;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">module.exports = db.model('Tag', TagSchema);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/task.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/task.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">13</div><div class="hits">13</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// task.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose')</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Schema = mongoose.Schema;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var connect = rootRequire('./config/db');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var db = connect.db;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">// TODO: Tasks are actually just discussion guidelines</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">// They store no messages and are not used to associate data?</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var TaskSchema = new Schema ({</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    _messages:[{ type: Schema.Types.ObjectId, ref: 'Message' }],</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    _tags: [{ type: Schema.Types.ObjectId, ref: 'Tag' }],</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    _subjects: [{ type: Schema.Types.ObjectId, ref: 'Subject' }],</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    _test : { type: Schema.Types.ObjectId, ref: 'Test' },</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    doctype : { type: String, trim: true, default: 'task' },</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    name: { type : String, trim : true },</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    desc : { type : String, trim : true },</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    summary: { type : String, trim : true },</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    pass_fail: { type: Boolean, default: true },</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    visible: { type:Boolean, default: true },</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    embed   : { type: String, default: '' },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    index: Number,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    report_index: Number,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    created: Date,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    updated: Date,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">TaskSchema.pre('save', function(next){</td></tr><tr class="hit"><td class="line">36</td><td class="hits">15</td><td class="source">    var now = new Date();</td></tr><tr class="hit"><td class="line">37</td><td class="hits">15</td><td class="source">    this.updated = now;</td></tr><tr class="hit"><td class="line">38</td><td class="hits">15</td><td class="source">    if ( !this.created ) {</td></tr><tr class="hit"><td class="line">39</td><td class="hits">15</td><td class="source">        this.created = now;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">41</td><td class="hits">15</td><td class="source">    next();</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">module.exports = db.model('Task', TaskSchema);</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/test.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/data/test.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">13</div><div class="hits">13</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// test.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Schema = mongoose.Schema;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var connect = rootRequire('./config/db');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var db = connect.db;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">// TODO: Tests are the basic organizing unit for </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">// subjects, who generate messages on each discussion guide unit</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// This document replaces a table-join and allows structure around</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// how we call messages and subjects into relations with each other.</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">var TestSchema = new Schema({</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        _tasks: [{ type: Schema.Types.ObjectId, ref: 'Task' }],</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        _subjects: [{ type: Schema.Types.ObjectId, ref: 'Subject' }],</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        doctype : { type: String, trim: true, default: 'test' },</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        created_by_account : {type: Schema.Types.ObjectId},</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        created_by_user : {type: Schema.Types.ObjectId},</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        last_run : Date,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        desc    : { type: String, trim: true, default: '' },</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        link    : { type: String, trim: true, default: '' },</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        name    : { type: String, trim: true },</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        platform: { type: String, trim: true, default: 'mobile' },</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        kind    : { type: String, trim: true, default: '' },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        embed   : { type: String, default: '' },</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        index: { type: Number, default: 0 },</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        report_index : { type: Number, default: 0 },</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        visible: { type:Boolean, default: true },</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        report : { type:Boolean, default: false },</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        created: Date,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        updated: Date,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        runcount : Number,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        summary: String</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">TestSchema.pre('save', function(next){</td></tr><tr class="hit"><td class="line">43</td><td class="hits">4</td><td class="source">    var now = new Date();</td></tr><tr class="hit"><td class="line">44</td><td class="hits">4</td><td class="source">    this.updated = now;</td></tr><tr class="hit"><td class="line">45</td><td class="hits">4</td><td class="source">    if ( !this.created ) {</td></tr><tr class="hit"><td class="line">46</td><td class="hits">2</td><td class="source">        this.created = now;</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">48</td><td class="hits">4</td><td class="source">    next();</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">module.exports = db.model('Test', TestSchema);</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/add-subject.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/add-subject.js</h2><div id="stats" class="terrible"><div class="percentage">14%</div><div class="sloc">14</div><div class="hits">2</div><div class="misses">12</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// add-subject.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// add a test subject</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(request, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var async    = require('async');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">    var Test     = global.rootRequire('./server/models/data/test');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">// CREATE A NEW SUBJECT ===================================</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    async.waterfall([function(callback){</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">        Subject.create({</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">            name     : request.name,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            testroom : request.testroom,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            test     : request.test</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        function(err, data){</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">            callback(null, data);</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    }, function(subject, callback){</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        Test.findOneAndUpdate(</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            {'_id' : subject.test},</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            {'last_run' : new Date(),</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">              $push : { _subjects : subject._id } </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            function(err, test){</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">                callback(null, subject);</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    }], function(err,results){</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">            if(err){console.log(err);} </td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">            next(null, results);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/build-object-list.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/build-object-list.js</h2><div id="stats" class="terrible"><div class="percentage">5%</div><div class="sloc">36</div><div class="hits">2</div><div class="misses">34</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// build-object-list.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// Builds the left navigation array for report routes</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(report_id, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var _ = require('lodash');</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var async = require('async');</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var Promise = require('bluebird');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">// CREATE THE LEFT NAVIGATION LIST ========================</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    // get all relevant objects, sanitize them and return them in an array</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    // TODO: When we make tasks, they live in the Test, and the Test stores their order, right?</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    // Right. They aren't returned to the Test this way. This is purely for Reports.</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    // Sooooooo, normal index is no use.</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    // TODO: FIX ON TEST CREATION PAGE.</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">    async.parallel({</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        tags: function(callback){</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">            Tag.find({'_test' : report_id })</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">                .sort({name: 1})</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                .exec(function(err, docs){</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">                    if (err) { console.log(err); }</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">                    if(!docs ){ callback(null, null); }</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">                    callback(null, docs);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        tasks: function(callback){</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">            Task.find({'_test': report_id})</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                .sort({ report_index: 'asc'})</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                .exec(function(err, docs){</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">                    if (err) { console.log(err); }</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                    if(!docs ){ callback(null, null); }</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                    callback(null, docs);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        test: function(callback){</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">            Test.find({'_id' : report_id})</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                .limit(1)</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">                .exec(function(err, docs){</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">                    if(!docs ){ callback(null, null); }</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">                    callback(null, docs);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    function(err, results) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        var return_array = [];</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        if (results.test){</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">            _.each(results.test, function(test){</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                return_array.push(test);</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">        if(results.tasks){</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">            _.each(results.tasks, function(task){</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                return_array.push(task);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">        if(results.tags){</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">            _.each(results.tags, function(tag){</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">                return_array.push(tag);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        // todo: refactor so this does not fail if things are null.</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">        if(results.test.length &gt; 0){</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">            var navlist = {</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                test: results.test[0].name,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                list: return_array</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">        next(null, navlist);</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/build-summary.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/build-summary.js</h2><div id="stats" class="terrible"><div class="percentage">14%</div><div class="sloc">14</div><div class="hits">2</div><div class="misses">12</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// build-summary.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// builds out the response object for a summary.</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(report_id, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">7</td><td class="hits">0</td><td class="source">    var async = require('async');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// load functions ===============================</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var buildNavList   = global.rootRequire('./server/models/functions/build-object-list');</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var buildMsgList   = global.rootRequire('./server/models/functions/messages-list');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// BUILD A REPORT OBJECT ==================================</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    async.parallel({</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        navlist: function(callback){</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">            buildNavList(report_id, function(err, list){</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">                callback(null, list);</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        messages: function(callback){</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">            buildMsgList(report_id, function(err, list){</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">                callback(null, list);</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    function(err, results){</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">        if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">        next(null, results);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/comment.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/comment.js</h2><div id="stats" class="terrible"><div class="percentage">14%</div><div class="sloc">14</div><div class="hits">2</div><div class="misses">12</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// comment.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// create a new comment.</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(request, user, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">7</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var Comment = global.rootRequire('./server/models/data/comment');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">// COMMENT ON A MESSAGE ===================================</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var reply = {};</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    var promise = Comment.create( {</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">            name: user.name,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">            body: request.body,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">            created_by_user: user._id</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        function(err, cmt){</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">            if(err){ console.log(err); }</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    promise.then(function(comment){</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        reply.comment = comment;</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        return Message.findOneAndUpdate(</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            {'_id' : request.msg},</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            {$push : {_comments: comment._id}},</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            function(err, msg){</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">                if (err) {console.log(err);}</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    }).then(function(){</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        Message.findOne({'_id': request.msg})</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">           .populate('_comments _subject')</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">           .exec(function(err, msg){</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">                if (err) { console.log(err);}</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">                next(null, msg);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/create-invite.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/create-invite.js</h2><div id="stats" class="terrible"><div class="percentage">6%</div><div class="sloc">31</div><div class="hits">2</div><div class="misses">29</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// create-invite.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// Create a new invitation</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(address, inviter, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies ====================================</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // Permits use of ObjectID type</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var _        = require('lodash');</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var async    = require('async');</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var Promise  = require('bluebird');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// Load models ============================================</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var User       = global.rootRequire('./server/models/auth/user');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Invitation = global.rootRequire('./server/models/auth/invitation');</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    var Emailer    = global.rootRequire('./server/models/mailer');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">// Create an invitation ===================================</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">            User.findOne({'local.email' : address })</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">                .exec(function(err, user){</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">                    if(!user){</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                        // if there is no user, set user to null.</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">                        callback(null, null);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">                    else {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                        // otherwise pass along the user.</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">                        callback(null, user.local.email+' already has a Field Guide account.');</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        function(user, callback){</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">            if(user !== null ){</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                // If there is a user, skip the invite chain and return.</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">                callback(null, user);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">            Invitation</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                .findOne({'invite_email' : address})</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                .exec(function(err, i){</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                    if(!i){ </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                        // if there is no invitation, pass to next step.</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                        callback(null, null); </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                    else {</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                        // if there is an invite, pass that to results.</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                        callback(null, 'You have already sent that invitation.');</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        function(args, callback){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">            if(args !== null){</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                // If either a user or an invitation exists on the system, pass it along.</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                callback(null, args);</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            // Send an invitation in e-mail to whomever.</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            // TODO: Promisify this bit.</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">            Invitation.create({</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                _account : inviter._account,</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                created_by_user : inviter._id,</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                invite_email : address</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            }, function(err, invite){</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">                if(err){ console.log(err); }</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">                var mailer = new Emailer(</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                    { to: { email: invite.invite_email, },</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                      author: invite._account,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                      subject: &quot;Invite from Field Guide&quot;,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                      template: &quot;invite&quot;</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                    { invitation_by: inviter.name,</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                      invite_link: 'http://projects.fieldguideapp.com/login/'+invite._id</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">                mailer.send(function(err, result) {</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">                    if (err) { </td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">                        console.log(err); </td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">                    callback(null, 'Invitation sent to '+ invite.invite_email);</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    ], </td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    function(err, results){</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">        if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">        next(null, results);</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/default-tests.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/default-tests.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">24</div><div class="hits">24</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// default-tests.js - generates first-time signup tests</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(account, id, callback, debug){</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">// on first login via signup, create a test for this user.</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var _ = require('lodash');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var async = require('async');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// load data storage models</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">// Abstract and create tests </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var new_test_1 = {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        created_by_account: account,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        created_by_user : id,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        name : &quot;Ex. Customer Interview - Fitness Habits&quot;,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        desc : &quot;1. Understand people's current fitness habits \n&quot;+</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">               &quot;2. Understand whether they look for digital tools to help modify their fitness habits\n&quot;+</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">               &quot;3. Determine if family, friends or peers play an important role in shaping people's fitness behaviour.&quot;,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        kind : &quot;interview&quot;</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    var new_test_2 = {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        created_by_account: account,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        created_by_user : id,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        desc : &quot;1. Understand whether Email Inbox is designed according to users' expectations for email clients.\n&quot;+</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">               &quot;2. Measure whether Delete, Add Recipient and Reply functions are intuitive for users.\n&quot;+</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">               &quot;3. Evaluate if the iconography used in the Email Inbox is easily understood by users.&quot;,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        kind : &quot;prototype&quot;,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        link : &quot;http://invis.io/2J1SN6AYV&quot;,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        name : &quot;Ex. Prototype Testing - Email Inbox App&quot;</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    async.parallel([</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">            Test.create(new_test_1 , function(err, test){</td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">                var tasks = [</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                    {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                        _test : test._id,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                        name  :&quot;Introduction&quot;,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                        desc  :&quot;Note: This is to set the tone for the interviewee or group. Well introduce ourselves and set ground rules for the discussion.\n- My name is __________.\n- Thanks for talking to us today, well be about 60 minutes.\n- Were constantly trying to improve our product, and getting your frank feedback is a really important part of that.\n- This discussion is confidential  your personal information or specific answers wont be used publicly so dont hesitate speak your mind.\n- No right or wrong answers - very important to not say what you think I want to hear, but what you are actually thinking/feeling. Feel free to stop us at anytime for clarification, questions, or concerns.\n- Well be running through a few questions and scenarios from your day. \n- Wed like you to speak out loud and tell us about everything youre thinking/feeling/etc.\n- Youll be recorded, but this information will not be distributed beyond our team.\n- Alright, let's get started!&quot;,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                        index : 0</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                    }, {</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                        _test : test._id,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">                        name  : &quot;Background Information&quot;,</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                        desc  : &quot;- What is your name and age? \n - Where do you live? \n - What kind of work do you do?\n- For how long have you been doing that?\n- What kinds of activities, hobbies or projects do you like to do when youre not working?&quot;,</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                        index : 1</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                    {</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                        _test : test._id,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                        name  : &quot;Current Activities and Habits&quot;,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                        desc  : &quot;- What do you do to take care of yourself? To stay in shape? To stay active? \n - Can you list the sports, exercise, classes you participate in?\n- How many times did you participate in the activities in the last week?\n- Are there any other healthy habits in your day?&quot;,</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                        index : 2</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                    {</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                        _test : test._id,</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                        name  : &quot;Fitness Apps and Tools&quot;,</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                        desc  : &quot;- Have you used any apps or websites or other programs to help you with fitness? Which ones?\n- What did you want them to do for you?\n- What was your expected out come from using these apps?\n- What do you like about them?\n- What do you dislike about them?\n- Did you pay for them? Why? Why not?&quot;,</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                        index : 3</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                    {</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                        _test : test._id,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                        name  : &quot;Friends and Social Activity&quot;,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                        desc  : &quot;- Who (e.g. friends, family, coaches, teachers?) helps keep you active?\n- How do they help you?\n- Who (e.g. friends, family, coaches, teachers?) is a barrier to you being active?\n- How do they prevent you from being active?\n- Do you share info about your workouts or your goals with anyone?\n- When? Why? How?\n- What (if anything) do you do to keep track of what youre doing?\n- How does that help you?&quot;,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                        index : 4</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                    {</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                        _test : test._id,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                        name  : &quot;Exercise Habits&quot;,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                        desc  : &quot;- How have your exercise habits changed over time?\n- What did you used to do 6 months ago?\n- What did you used to do where at your fittest?\n- Have the software and tools you use changed? Which did you used to use?&quot;,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                        index : 5</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                    {</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">                        _test : test._id,</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                        name  : &quot;Conclusion and Thank You&quot;,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                        desc  : &quot;- Thanks participant for their time\n- Get them to initial sign-in sheet, and hand them their reimbursement\n- Provide assistance with leaving building\n- High fives!&quot;,</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                        index : 6</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    }];</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">                Task.create(tasks, function(err, t0, t1, t2, t3, t4, t5, t6){</td></tr><tr class="hit"><td class="line">85</td><td class="hits">1</td><td class="source">                    test._tasks.push(t0._id, t1._id, t2._id, t3._id, t4._id, t5._id, t6._id);</td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">                    test.save(function(err, new_test){</td></tr><tr class="hit"><td class="line">87</td><td class="hits">1</td><td class="source">                        callback(null, new_test);</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="hit"><td class="line">93</td><td class="hits">1</td><td class="source">            Test.create(new_test_2 , function(err, test){</td></tr><tr class="hit"><td class="line">94</td><td class="hits">1</td><td class="source">                var tasks = [{</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">                    _test: test._id,</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">                    name :&quot;Introduction&quot;,</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                    desc :&quot;Note: This is to set the tone for the interviewee. Well introduce ourselves and set ground rules for the discussion.\n- My name is __________.\n- Thanks for talking to us today, well be about 30 minutes.\n- Were going to talk about a new app we're designing.\n- This discussion is confidential  your personal information or specific answers wont be used publicly so dont hesitate speak your mind.\n- No right or wrong answers - very important to not say what you think I want to hear, but what you are actually thinking/feeling. Feel free to stop us at anytime for clarification, questions, or concerns.\n- Well have you play around with a few things weve been working on. Wed like you to speak out loud and tell us about everything youre thinking/feeling/etc.\n- Youll be recorded, but this information will not be distributed.&quot;,</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                    index:0</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                },{</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                    _test: test._id,</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                    name :&quot;Email Habits Background&quot;,</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                    desc :&quot;- Which company do you use for your email accounts?\n- Do you have separate providers for your personal and work accounts?\n- As a percentage, how much of your email creation and management do you do on your mobile devices?\n- Which mobile device do you use?\n- Do you use any email apps, other than those that came pre-installed? If so, which ones?\n- Why did you switch email apps from those that are on your phone?&quot;,</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                    index:1</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                },{</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">                    _test: test._id,</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                    name :&quot;Task 1 - Landing in your inbox&quot;,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                    desc :&quot;Ok, great, now we've going to get you to play with an email app we are designing. Pick up the phone in front of you and unlock it. I want you to pretend that you we're out shopping, and just remembered that you needed to email a friend to make plans for dinner.\n- What is the first thing you notice when you land in your inbox?\n- Walk me through the elements you see on the screen.\n- Talk me through your thought process when you are confronted with unread emails.\n- After seeing your inbox, what is the first action you want to take?&quot;,</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                    index:2</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                },{</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                    _test: test._id,</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                    name :&quot;Task 2 - Managing unread email&quot;,</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                    desc :&quot;Alright, let's read that email from Billy Kiely. Tap on that item.\n- What is the first thing you notice when you land on this screen?\n- Does the oder that the messages are displayed in make sense to you?\n- If you wanted to reply to Laura, what would you do?\n- If you wanted to reply to Billy, what would you do?\n- If you decided you don't really want to see these people, and wanted to delete these emails, what would you do next? Why?&quot;,</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                    index:3</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                },{</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                    _test: test._id,</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                    name :&quot;Task 3 - Writing a new email&quot;,</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                    desc :&quot;Alright, let's send that recipe to your friend. So let's write a new email.\n- Where would you click in your inbox to start writing a new email?\n- What is the first action you take when you are sending a new email?\n- Do you understand what all of these labels mean?\n- If you want to add someone to the 'To:' field, how would you do that?\n- Why do you think the plus sign turned into a minus sign once you added a recipient to this email?\n- Talk me through how you identify your contacts when you add them to an email?\n- Now type out your email, (email text should appear when they click on Subject or Email Input fields,) and send it.\n- What did you think of that? Was that what you expected? Why or why not?&quot;,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                    index:4</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                },{</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                    _test: test._id,</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                    name :&quot;Task 4 - Deleting emails&quot;,</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                    desc :&quot;Ok, so your are back in your inbox. Now it is time to clear out unwanted messages. Jon is trying to make dinner plans with you, but you already have plans with Billy. Let's just delete Jon's message without replying.\n- What would you do next? Why?\n- Is there anything else you would do at this point?\n- What additional info would have helped?\n- Is that a familiar action for you based on other apps you use regularly?&quot;,</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                    index:5</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                },{</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                    _test: test._id,</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                    name :&quot;Thoughts and Feedback on the Experience&quot;,</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                    desc :&quot;- Having walked through this experience now, how did it compare to your experiences with other email apps?\n- Is it better or worse? Why?\n- Do you think you would use this email app?\n- What did you feel was missing? \n- What did you find confusing?\n- Do you have any other thoughts or feedback for us?&quot;,</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                    index:6</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                },{</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                    _test: test._id,</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                    name :&quot;Conclusion and Thank You&quot;,</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                    desc :&quot;- Thanks participant for their time\n- Get them to initial sign-in sheet, and hand them their payment cheque\n- Provide assistance with leaving building\n- High fives!&quot;,</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                    index:7</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                }];</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">136</td><td class="hits">1</td><td class="source">                Task.create(tasks, function(err, t0, t1, t2, t3, t4, t5, t6, t7){</td></tr><tr class="hit"><td class="line">137</td><td class="hits">1</td><td class="source">                    test._tasks.push(t0._id, t1._id, t2._id, t3._id, t4._id, t5._id, t6._id, t7._id);</td></tr><tr class="hit"><td class="line">138</td><td class="hits">1</td><td class="source">                    test.save(function(err, new_test){</td></tr><tr class="hit"><td class="line">139</td><td class="hits">1</td><td class="source">                        callback(null, new_test);</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">    ],</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    // optional callback</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    function(err, results){</td></tr><tr class="hit"><td class="line">147</td><td class="hits">1</td><td class="source">        Test.find({'created_by_user' : id}).populate('_tasks').exec();</td></tr><tr class="hit"><td class="line">148</td><td class="hits">1</td><td class="source">        callback(null, results);</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/delete-task.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/delete-task.js</h2><div id="stats" class="terrible"><div class="percentage">7%</div><div class="sloc">28</div><div class="hits">2</div><div class="misses">26</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// delete-task.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(task, next){</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies</td></tr><tr class="miss"><td class="line">7</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var _ = require('lodash');</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var async = require('async');</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">// load data storage models</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">// delete a task</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    // find a task</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    // remove it from its test</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    // remove all related messages and tags </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">    async.parallel([</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">            Task.findById(task, function(err, doc){</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">                if(err){ console.log(err); }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">                Test.findOne({'_id': doc._test})</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">                    .exec(function(err, test){</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">                        if(err){ console.log(err); }</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">                        test._tasks.remove(doc._id);</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">                        test.save(function(err,data){</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">                            if(err){console.log(err);}</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            .remove(function(err){</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">                callback(null, 'task');</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">            Message.remove({ '_task' : task }, </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                function(err, msg){</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">                    callback(null, 'msg');</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">            Tag.remove({_task: task},</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                function(err, msg){</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                    callback(null, 'tag');</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    ], </td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    function(err, results){</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">        if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">        next(task);</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/delete-test.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/delete-test.js</h2><div id="stats" class="terrible"><div class="percentage">8%</div><div class="sloc">24</div><div class="hits">2</div><div class="misses">22</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// delete-test.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// deletes a single test by id and all related tasks, messages, tags</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(test, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">7</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // THIS MAKES MESSAGE AGGREGATION WORK IN TEST RETURNS FOR SUMMARIES.</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var _ = require('lodash');</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var async = require('async');</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">// DELETE TEST ============================================</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    async.parallel([</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">            Test.remove({ _id : test}, </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">                function(err){</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">                    if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">                    callback(null, 'test');</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">            Task.remove({ _test : test },</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">                function(err){</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">                    if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">                    callback(null, 'task');</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">            Message.remove({ _test : test }, </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                function(err){</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">                    if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">                    callback(null, 'messages');</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">            Tag.remove({ _test : test },</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                 function(err){</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                        if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                        callback(null, 'tags');</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    ], </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    function(err, results){</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">        if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">        next(null, test);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    });  </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/dev-tests.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/dev-tests.js</h2><div id="stats" class="terrible"><div class="percentage">3%</div><div class="sloc">64</div><div class="hits">2</div><div class="misses">62</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// dev-tests.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// Mocks for testing routes on live</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict'; </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(account, user, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var _ = require('lodash');</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var async = require('async');</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var Promise = require('bluebird');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// load data storage models</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">// The promisified chain to make this a WHOLE bunch cleaner...</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">// https://gist.githubusercontent.com/artcommacode/45c85e867d1bd1f3c1bb/raw/gistfile1.js</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">// var tasks = [{</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">//   name: &quot;Task 1&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">//   desc: &quot;Chase ball of string and scratch the furniture and always hungry. \n- Nap all day.&quot;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">// }, {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">//   name: &quot;Task 2&quot;,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">//   desc: &quot;Sunbathe climb the curtains run hiss purr. \n- Puking I don't like that food claw scratched eat.&quot;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">// }]</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">// var createTest = Promise.promisify(Test.create, Test)</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">// var createTask = Promise.promisify(Task.create, Task)</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">// var saveTest = Promise.promisify(test.save, test)</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">// createTest(test).then(function (test) {</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">//   return Promise.all(tasks.map(function (task) {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">//     task._test = test._id</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">//     return createTask(task)</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">//   })).then(function (tasks) {</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">//     test._tasks.concat(tasks)</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">//     return saveTest(test)</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">//   })</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">// }).then(function (test) {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">//   console.log('done')</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">// }).catch(function (error) {</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">//   console.log(error)</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">// })</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">// Alright, run the waterfall - whcih could also be a promise chain.</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">            async.waterfall([</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                function(callback){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                    Test.create({</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                        created_by_account: account,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                        created_by_user : user,</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                        name : &quot;DeveloperTest&quot;,</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                        desc : &quot;- Pew\n&quot;+</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                               &quot;- Rub face on everything.\n&quot;,</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                        kind : &quot;interview&quot;</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                    function(err, test){</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">                        var tasks = [{</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                                _test : test._id,</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                                name  :&quot;Task 1&quot;,</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                                desc  :&quot;Chase ball of string and scratch the furniture and always hungry. \n- Nap all day.&quot;,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                                index : 0</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                            }, </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                            {</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                                _test : test._id,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                                name  : &quot;Task 2&quot;,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                                desc  : &quot;Sunbathe climb the curtains run hiss purr. \n- Puking I don't like that food claw scratched eat.&quot;,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                                index : 1</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                            }];</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">                        Task.create(tasks, function(err, t0, t1){</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">                            test._tasks.push(t0._id, t1._id);</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">                            test.save(function(err, data){</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">                                callback(null, data);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                }, </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                function(arg, callback){</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">                    Subject.create({ name: 'Jane she is a cat' },</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">                        function(err, data){</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">                            if (err) { console.log(err); }</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                            callback(null, {test: arg, subject: data});</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                function(arg, callback){</td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">                    async.parallel({</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">                        test: function(done){</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                            Test.findOne({'_id' : arg.test._id})</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">                                .exec(function(err, test){</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">                                    test._subjects.push(arg.subject._id);</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">                                    test.save(function(err, saved){</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">                                        done(null, saved);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                                    });</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                        tasks: function(done){</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">                            async.map(arg.test._tasks,</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                                function(task, yeah){</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">                                    Task.findOne({'_id' : task})</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                                        .exec(function(err, item){</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">                                            item._subjects.push(arg.subject._id);</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">                                            item.save(function(err, saved){</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">                                                yeah(null, saved);</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                                            });</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                                        });</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                                }, </td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                            function(err, results){</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">                                done(null, results);</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                    }, </td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                    function(err, results){</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">                        callback(null, {tasks: results.tasks, test: results.test, subject: arg.subject});</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                function(arg, callback){</td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">                    var arr = [</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                            {</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                                body:'One #yellow #blue #green',</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                                _test: arg.test._id,</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                                _subject: arg.subject._id</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                            },</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                            {</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                                body:'Two #yellow #blue',</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                                _test: arg.test._id,</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                                _subject: arg.subject._id</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                            },</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                            {</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                                body:'Three #yellow',</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">                                _test: arg.test._id,</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                                _subject: arg.subject._id</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">                        ];</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                    // concatenate 2X arr for an array to transcribe to messages</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">                    // this will create a rack of messages to put into tests.</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">                    var arr2 = arr.concat(arr);</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">                    Message.create( arr2,</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">                        function(err, d0, d1, d2, d3, d4, d5){</td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="source">                            if (err) { console.log(err);} </td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">                            // TODO: Something in here is rotten because</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">                            // Tags cross-delete between tests when deleting OR creating a NEW test</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">                            // They also persist their visibility, which should not be.</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">                            var output = {</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                                task1 : [d0._id, d1._id, d2._id],</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">                                task2 : [d3._id, d4._id, d5._id],</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">                                yellow: [d0._id, d1._id, d2._id, d3._id, d4._id, d5._id],</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                                blue: [d0._id,d1._id,d3._id,d4._id],</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">                                green: [d0._id,d3._id],</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">                                subject: arg.subject,</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">                                test: arg.test,</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">                                tasks: arg.tasks</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">                            };</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                           </td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">                            callback(null, output);</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                function(arg, callback){</td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">                    async.parallel([</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                        function(callback){</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                            arg.subject._messages = arg.yellow;</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">                            arg.subject.save(function(err, subject){</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">                                if (err) { console.log(err); }</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                                callback(null, subject);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                        function(callback){                    </td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">                            arg.tasks[0]._messages = arg.task2;</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">                            arg.tasks[0].save(function(err,data){</td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="source">                                if (err) { console.log(err); }</td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">                                callback(null, data);</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                        function(callback){                    </td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="source">                            arg.tasks[1]._messages = arg.task2;</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">                            arg.tasks[1].save(function(err,data){</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                                if (err) { console.log(err); }</td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="source">                                callback(null, data);</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">                        function(callback){</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">                            // this needs to be by test and tag.</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">                            // test issss...</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                            Tag.findOneAndUpdate(</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">                                {'name': 'yellow', '_test' : arg.test._id },</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">                                {'_messages': arg.yellow,</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">                                '_test': arg.test._id },</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">                                { upsert: true },</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">                                function(err, data){</td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">                                    callback(null, data);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">                        function(callback){</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">                            Tag.findOneAndUpdate(</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">                                {'name': 'blue', '_test' : arg.test._id },</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">                                {'_messages': arg.blue,</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">                                 '_test': arg.test._id },</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">                                { upsert: true },</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">                                function(err, data){</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">                                    callback(null, data);</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">                        function(callback){</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">                            Tag.findOneAndUpdate(</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">                                {'name': 'green', '_test' : arg.test._id },</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">                                {'_messages': arg.green,</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">                                 '_test': arg.test._id },</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">                                { upsert: true },</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">                                function(err, data){</td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">                                    callback(null, data);</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">                    ], </td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">                    function(err, results){ </td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">                        callback(null, { test : arg.test });</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">            ], </td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">            function(err, results){</td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">                callback(null, results);</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">            });                </td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">        function(arg, callback){</td></tr><tr class="miss"><td class="line">233</td><td class="hits">0</td><td class="source">            callback(null, arg);</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">    ], </td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">    function(err, results){</td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">        console.log('route results', results);</td></tr><tr class="miss"><td class="line">238</td><td class="hits">0</td><td class="source">        next(null, results.test);</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/dupe-tests.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/dupe-tests.js</h2><div id="stats" class="terrible"><div class="percentage">5%</div><div class="sloc">37</div><div class="hits">2</div><div class="misses">35</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// dupe-tests.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">// This duplicates existing tests and all their information.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">module.exports = function(test, next){</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">// Module dependencies</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var _ = require('lodash');</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var async = require('async');</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">    var Promise = require('bluebird');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">// load data storage models</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">// Duplicate existing tests through a waterfall callback.</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    console.log(test);</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        function(callback) {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">            Test.findById(test)</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                .populate({path:'_tasks'})</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">                .exec(function(err, doc){</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">                    callback(null, doc);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        function(args, callback){</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">            var old = args;</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">            var update = {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                    created_by_account : old.created_by_account,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                    created_by_user : old.created_by_user,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                    desc    : old.desc,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                    link    : old.link,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                    name    : old.name || &quot;New Test&quot;,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                    platform: old.platform,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                    kind    : old.kind,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                    visible : 'true'</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">            Test.create(update, function(err, test){</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">                if (err){console.log(err);}</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                callback(null, {'old' : old, 'test' : test});</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        function(args, callback) {</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">            if(args.old._tasks){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                async.map(args.old._tasks, function(task, callback){</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                    var make =  {</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                        desc : task.desc,</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                        index : task.index,</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                        name : task.name,</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                        visible : 'true',</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                        _test : args.test._id</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">                    Task.create(make, function(err, doc){</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">                        if (err){ console.log(err); }</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                        callback(null,doc._id);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                }, function(err, results){</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">                    console.log('callback', results);</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">                    callback(null, {tasks: results, test: args.test});</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">                callback(null, {test: args.test});</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        function(args, callback){</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">            if(args.tasks){</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">                args.test._tasks = args.tasks;</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">                args.test.save(function(err,test){</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">                    if (err){ console.log(err); }</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">                    callback(null, test);</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">    ], function (err, result) {</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">        if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">        next(err, result);</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/edit-message.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/edit-message.js</h2><div id="stats" class="terrible"><div class="percentage">4%</div><div class="sloc">46</div><div class="hits">2</div><div class="misses">44</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// message-edit.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// Edit the body of a message and associate it to new tags</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(msg, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var _        = require('lodash');</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var async    = require('async');</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var Promise  = require('bluebird');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">// load functions ===============================</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    var tagPuller = global.rootRequire('./server/models/functions/tag-puller.js');</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    var tags = tagPuller(msg.body);</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">// EDIT A MESSAGE =========================================</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    // edit a message. First edit tags related to message, then edit message body.</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    // find all tags in the db with this test name</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    // if a tag matching a given req.body.tag does not exist, create it</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    // if tag does exist, and message is not already present on it, push message</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    // if there are tags returned that are not in req.body.tags, remove message</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    // if there are tags returned that are empty of messages, delete them</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    // reply with res.json({tags : tags, msg: msg});</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    // globals to sort through</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        function(callback) {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            // Find all the tags that are in the new list</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            // If there's a tag in the new list not in the DB, make it, push msg</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            // If the tag's there and doesn't have the msg, push it, save.</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">            async.map(tags, function (name, callback) {</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">                Tag.findOne({'name' : name})</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                    .exec(function (err, doc) {</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                        if(err){ console.log(err); }</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                        var tg = doc[0];</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">                        if (!tg) {</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                            // create a new tag and push a message to it, save and exit</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                            var t = new Tag();</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">                            t.name = name;</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">                            t._test = msg._test;</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">                            t._messages.push(msg._id);</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                            t.save(function(err, tag){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                                callback(null, tag);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                        } else {</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                            // if an existing tag _messages does not contain msg._id</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                            </td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">                            if (tg._messages.indexOf(msg._id) === -1) {</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                                tg._messages.push(msg._id);</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">                                tg.save(function(err, tag){</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">                                    callback(null, tag);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                            } else {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">                                callback(null, tg);</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                        } </td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            }, callback);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        function(tag_set, callback){</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">            // Save the new message body</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">            Message.findOne({'_id' : msg._id})</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">               .exec(function(err, m){</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">                    m.body = msg.body;</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">                    m.save(function(err, data){</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">                        callback(null, {data: data, tag_set: tag_set});</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        function(args, callback){</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">             // Find tags that have an association with that message, </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">             // then send them to have new messages added to their joins</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">            async.waterfall([</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                function(callback) {</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">                    Tag.find({'_messages' : {$in : [msg._id]}, 'name' : {$nin : tags}})</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">                       .exec(function(err, docs){</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                            if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">                            callback(null, docs);</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                function(args, callback) {</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">                    async.map(args, function(tag, callback){</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                        var msg_index = tag._messages.indexOf(msg._id);</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">                        tag._messages.splice(msg_index, 1);</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">                        tag.save(function(err,doc){</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">                            callback(null, tag);</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                    }, callback);</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">            ], function (err, result) {</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">                if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">                callback(null, args);</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        function(args, callback){</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">            // If there are tags that still hold messages that have been deleted</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">            // Remove the reference to those messages from the tag</td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">            Tag.remove({'_messages' : {$size : 0}}, function(err, gone){</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">                callback(null, args);</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        }      </td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    ], function (err, result) {</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">        // result should be {data: data, tag_set: tag_set} from line 77.</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">        if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">        next(result);</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/edit-test.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/edit-test.js</h2><div id="stats" class="terrible"><div class="percentage">9%</div><div class="sloc">22</div><div class="hits">2</div><div class="misses">20</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// edit-test.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// desperation function to get tasks to stay in proper array order</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';       </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(test, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var _        = require('lodash');</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var async    = require('async');</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var Promise  = require('bluebird');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Test   = global.rootRequire('./server/models/data/test');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Task       = global.rootRequire('./server/models/data/task');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">// EDIT A TEST ============================================ </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    var tasks = [];</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">            if(test._tasks.length &gt; 0){</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">                tasks = _.pluck(test._tasks, '_id');</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">                async.each(test._tasks, function(task){</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">                    Task.findOneAndUpdate(</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                        {'_id': task._id},</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">                        {index : task.index },</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">                        function(err, doc){</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">                            if(err){console.log(err);}</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">                callback(null, tasks);</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">                callback(null, null);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        function(tasks, callback){</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">            Test.findOneAndUpdate(</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">            { _id : test._id },</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            {</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                desc    : test.desc,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                link    : test.link,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                name    : test.name,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                platform: test.platform,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                kind    : test.kind,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">                _tasks  : tasks</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">            { upsert : true },</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">            function (err, doc) {</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                if (err){console.log(err);}</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                callback(null, doc);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    ], </td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    function(err, results){</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">        if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">        next(null, results);</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/message-fav.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/message-fav.js</h2><div id="stats" class="terrible"><div class="percentage">16%</div><div class="sloc">12</div><div class="hits">2</div><div class="misses">10</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// message-fav.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// update a message as visible or not on report screen.</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(message_array, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var _        = require('lodash');</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var async    = require('async');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    var Message  = global.rootRequire('./server/models/data/message');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">// Map an array of messages and return them as favourited ===============</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    async.map(message_array,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        function(msg, callback){</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">            Message.findByIdAndUpdate(</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">                msg._id, </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">                { </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">                    'fav_task' : msg.fav_task,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">                    'fav_tag'  : msg.fav_tag</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                }, </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                function(err, data){</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">                    callback(null, data);</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        }, </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        function(err, results){</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">            next(null, results);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/messages-list.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/messages-list.js</h2><div id="stats" class="low"><div class="percentage">33%</div><div class="sloc">6</div><div class="hits">2</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// messages-list.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// get all the messages for a given report</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(report_id, next){        </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">7</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// Get some messages for a report</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    Message.find({ '_test':{$in: [report_id]}})</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">       .populate({path:'_subject', select: 'name' })</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">       .populate({path:'_comments', select: 'name body created'})</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">       .exec(function(err, docs){</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">            next(null, docs);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/new-message.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/new-message.js</h2><div id="stats" class="terrible"><div class="percentage">5%</div><div class="sloc">34</div><div class="hits">2</div><div class="misses">32</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// new-message.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// create a new message on the DB</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(request, user, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var async    = require('async');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">// load functions ===============================</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    var tagPuller = global.rootRequire('./server/models/functions/tag-puller.js');</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">// CREATE A NEW MESSAGE ===================================</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">// set message variables from request object.</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">    var body = request.body,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        tags = tagPuller(body) || null,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        _subject = request._subject,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        _test = request._test,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        _task = request._task;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">    console.log('new message', request);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            // Create the message</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">            Message.create(</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                {</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                    _subject : _subject,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                    _test : _test,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                    body : body,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                    created_by : user</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                function(err, msg){</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                    if (err) { console.log(err); } </td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                    callback(null, msg);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        function(msg, callback){</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            // Return the message with the subject populated</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">            Message.findById(msg._id)</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                   .populate('_subject')</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                   .exec(function(err, note){</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">                        if (err) { console.log(err); }</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                        callback(null, note); </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        function(msg, callback){</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            // with the message populated, return the new message array</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">            async.parallel({</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                task: function(callback){</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                    if (_task){</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">                        Task.findOneAndUpdate(</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                            {'_id':_task},</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                            {$push: { _messages: msg._id }},</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                            {upsert : false },</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                            function(err, task){</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                                callback(null, task);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">                        callback(null, null);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                subject: function(callback){</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">                    Subject.findOneAndUpdate(</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                            {'_id': _subject},</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                            {$push: { _messages: msg._id }},</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                            {upsert : false },</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                            function(err, subject){</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">                                callback(null, subject);</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                tags: function(callback){</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    // If there are tags, map the messages into them.</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                    // reminder: the tags are not attached to the message. The message is attached to tags.</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">                    if(tags){</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">                        async.map(tags, </td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">                            function(tag, callback){</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">                                Tag.findOneAndUpdate( </td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">                                    {name: tag, _test: msg._test}, </td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                                    { $push: { _messages: msg._id },</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                                            name: tag,</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                                            _test: msg._test</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                                    }, </td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">                                    {upsert:true}, </td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">                                    function(err, data){ </td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">                                        callback(null, data);</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">                                    });</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                            }, </td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                            function(err, results){</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">                                callback(null, results);</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">                        callback(null, null);</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            }, function(err, results){</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                // End of parallel callback chain</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">                callback(null, {msg: msg, waterfall: results});</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">    ], </td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">    function(err, results){</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">        // End of waterfall chain - new message and tags return here.</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">        if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">        next(null, {msg: results.msg, tags: results.waterfall.tags});</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/object-updates.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/object-updates.js</h2><div id="stats" class="terrible"><div class="percentage">6%</div><div class="sloc">33</div><div class="hits">2</div><div class="misses">31</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// object-updates.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">// Takes an array of objects, finds each object in array on server</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">// posts an update and saves.</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// expects each object to have property _id at minimum.</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">module.exports = function(object_array, next){</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">    var _ = require('lodash');</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    var async = require('async');</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Promise = require('bluebird');</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">// load data storage models ==========================</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">// UPDATE OBJECTS FROM NAVIGATION LIST ====================</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">// Did we get a properly formed object array?</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    async.map(object_array, </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        function(obj, callback){</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">            var Model;</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">            if(obj.doctype === 'tag') { Model = Tag;  }</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">            if(obj.doctype === 'task'){ Model = Task; }</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">            if(obj.doctype === 'test'){ Model = Test; }</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">            Model.findOne({'_id' : obj._id})</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                 .exec(function(err, model){</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                    // todo: if there's a new subject, pass a subject in and update the subjects list.</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">                    if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">                    if(!model){ callback(null, null); }</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">                    model.report     = true;</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                    model.visible    = (obj.visible === false) ? obj.visible : true;</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                    model.pass_fail  = (obj.pass_fail === false) ? obj.pass_fail : true;</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                    model.summarized = (obj.summarized === false) ? obj.summarized : true;</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">                    model.embed      = obj.embed || model.embed || '';</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">                    model.summary    = obj.summary || model.summarized || '';</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                    model.report_index  = obj.report_index || model.report_index;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                    // if there's a subject</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                    // and the subject doesn't exist in the model already</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                    if(obj._subject &amp;&amp; model._subjects.indexOf(obj._subject) === -1){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                        model._subjects.push(obj._subject);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">                    model.save(function(err, mdl){</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">                        if(err){console.log(err); }</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">                        callback(null, mdl);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        function(err, results){</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">            next(null, results);</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/resend-invite.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/resend-invite.js</h2><div id="stats" class="terrible"><div class="percentage">11%</div><div class="sloc">18</div><div class="hits">2</div><div class="misses">16</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// resend-invite.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// Resend an extant invitation</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(inviteId, inviter, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">// Module dependencies ====================================</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var mongoose = require('mongoose');  // Permits use of ObjectID type</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var _        = require('lodash');</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    var async    = require('async');</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    var Promise  = require('bluebird');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// Load models ============================================</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var User       = global.rootRequire('./server/models/auth/user');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    var Invitation = global.rootRequire('./server/models/auth/invitation');</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    var Emailer    = global.rootRequire('./server/models/mailer');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">// Create an invitation ===================================</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    Invitation.findById(inviteId)</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        .exec(function(err,invite){</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">            var envelope_options = {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">                to: {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                    email: invite.invite_email,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                author: inviter.name,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">                subject: &quot;Invite from Field Guide&quot;,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                template: &quot;invite&quot;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">            var message_variables = {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                invitation_by: &quot;Field Guide&quot;,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                invite_link: 'http://projects.fieldguideapp.com/login/'+invite._id</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">            var mailer = new Emailer(envelope_options, message_variables);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">            mailer.send(function(err, result) {</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                if (err) {</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">                    return console.log(err);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                }else{</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                    console.log('Message sent: ' + result.response);</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                    next(invite);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/user-create.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/functions/user-create.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">26</div><div class="hits">26</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// user-create.js</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// create a new user on the system</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(user, next){</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="hit"><td class="line">7</td><td class="hits">2</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="hit"><td class="line">8</td><td class="hits">2</td><td class="source">    var _ = require('lodash');</td></tr><tr class="hit"><td class="line">9</td><td class="hits">2</td><td class="source">    var async = require('async');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">2</td><td class="source">	var bcrypt = require('bcrypt-nodejs');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="hit"><td class="line">13</td><td class="hits">2</td><td class="source">    var User = global.rootRequire('./server/models/auth/user');</td></tr><tr class="hit"><td class="line">14</td><td class="hits">2</td><td class="source">    var Invitation = global.rootRequire('./server/models/auth/invitation');</td></tr><tr class="hit"><td class="line">15</td><td class="hits">2</td><td class="source">    var newUserTests = global.rootRequire('./server/models/functions/default-tests.js');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">// CREATE A NEW USER ============================</td></tr><tr class="hit"><td class="line">18</td><td class="hits">2</td><td class="source">	async.waterfall([</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        function(callback){</td></tr><tr class="hit"><td class="line">20</td><td class="hits">2</td><td class="source">	            Invitation.findOne({'invite_email': user.email})</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">	                .exec(function(err, invite){</td></tr><tr class="hit"><td class="line">22</td><td class="hits">2</td><td class="source">	                    if (err){ console.log(err); }</td></tr><tr class="hit"><td class="line">23</td><td class="hits">3</td><td class="source">                        if( !invite ){ callback(null, null); }</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                        else {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                            // console.log('invite found', invite._account);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                        // there was a pending invite with that invite _id, and it's not pending now.</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">                            invite.pending = false;</td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">                            invite.save(function(err, data){</td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">                                callback(null, data);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">	                });</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        function(invite, callback){</td></tr><tr class="hit"><td class="line">35</td><td class="hits">2</td><td class="source">		    var pass = bcrypt.hashSync(user.password, bcrypt.genSaltSync(8), null);</td></tr><tr class="hit"><td class="line">36</td><td class="hits">2</td><td class="source">            User.create({ </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                'name' : user.name,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                '_account' : (invite !== null ) ? invite._account : mongoose.Types.ObjectId(),</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                'local.email' : user.email,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                'local.password' : pass</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            }, function(err, user){ </td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">                if (err){ console.log(err); }</td></tr><tr class="hit"><td class="line">43</td><td class="hits">2</td><td class="source">                callback(null, {invite: invite, user : user});</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        function(arg, callback){</td></tr><tr class="hit"><td class="line">47</td><td class="hits">2</td><td class="source">        	if(arg.invite === null ){</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        		// console.log('make some tests');</td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">                newUserTests(arg.user._account, arg.user._id, function(err, tests){</td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">                    callback(null, {user: arg.user, tests: true});</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        	} else {</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">        		callback(null, {user: arg.user, tests: false});</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        	}</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        }], function(err, results){</td></tr><tr class="hit"><td class="line">56</td><td class="hits">2</td><td class="source">        	if(err){console.log(err);}</td></tr><tr class="hit"><td class="line">57</td><td class="hits">2</td><td class="source">        	next(null, results);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/models/mailer.js">/Users/alexleitch/Documents/Heist/scout-dev/server/models/mailer.js</h2><div id="stats" class="low"><div class="percentage">48%</div><div class="sloc">25</div><div class="hits">12</div><div class="misses">13</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// emailer.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var nodemailer = require('nodemailer'),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">    ejs = require('ejs'),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">    fs = require('fs'),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    _ = require('lodash');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    // TODO: This is unclear, because it relies on prototype modification</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    // Perhaps alter to bring in line with style elsewhere.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var Emailer = (function() {</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    function mail(envelope_options, message_variables) {</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">        this.envelope_options = envelope_options;</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">        this.message_variables = message_variables;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        // console.log('envelope_options', envelope_options, 'message_variables', message_variables);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    mail.prototype.envelope_options =  {};</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    mail.prototype.message_variables = {};</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    mail.prototype.attachments = [{</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            fileName: &quot;fg-email-logo.gif&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            filePath: &quot;.public/layout/assets/fg-email-logo.gif&quot;,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            cid: &quot;logo@fieldguideapp&quot;</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        }];</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    mail.prototype.send = function(callback) {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">        var template = './server/views/emails/'+this.envelope_options.template+'.ejs';</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        var str = fs.readFileSync(template, 'utf8');</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        var html = ejs.render(str, this.message_variables);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        var messageData = {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            to: this.envelope_options.to.email,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            from: &quot;Field Guide App &lt;contact@fieldguideapp.com&gt;&quot;,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            subject: this.envelope_options.subject,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            html: html,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">            generateTextFromHTML: true,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            attachments: [{</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                filename: 'field_guide_image.jpg',</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                content: 'R0lGODlh8AAiAKIAAP///yMfIH6AgtXX2E1NT+nq677Awp2foiH5BAAAAAAALAAAAADwACIAAAP/CLrc/jDKSau9OOvNOx+HQAQkQQiG5xSGSJbCUah0bd943hjj678EmWog+BkDgoFuyWw6h72jkZCCFAYzyEEqFWSf4LCYafidDIO04RAlCRy8l7dRaCMP6HTIrBz7P1h/TltAVQ8FRXIMZWZfA1FBXw5sQH0bIiaZmpaaDGyaoJyZkgygmUkWiD5Uk5kHC48mbwufQQyYoKgMdaauFYwkrxSPclh1R14sUXMTqiWkF3Y/hj6eXAGcL9AK0i/CEsRGs7SKCsAEt96lXN8ABdfjEQOVF8dSKYlH7RSEAegb3V5Qe2GNSzYS2wAEJGEIwsKG/cadSxdsHRdD77jEc/jC/9KCNTEMkLJnxFwXByAExPCooN8+C8tUytQFoBo5GDOZKdTGMdgBSm7A+cCT71/LcgAmLsjXLspPoP4WZHSTs+EDYC+ByZE09QeKbkYtFmqQL6GEKCwb2DwaNEKUhG8VdDUbcYGPL3VNlqAYoGlHuXcBE8zQI6xYejev/UgLoN/QXeoI/42wtjHSB3Ex8+Q2+YHLpZ3zJgXC1y+Jg9gEk8gwj6EWKR4XirMipV0iwxXQSqgsWjPCngG+5LNasC9o12yRfCR93PgC3QqGqw6QgRBuqVLC5lOcGsJ2H5Zad4/W+QHvyw4yp98MQPrriuZkWhKtNHpkzqebV+maIVE8If/NTbPcUDMQscoiHmnlQzw9vDQBdBCc1xZwcLHnnmf3vaecXlE1Z9p47vGHQQ+GMIKCAuJ5xYAPVuXDoD8AgkXRRhTEJJNVEvoz0z7qNaDehZNkiOGE9bWXIYQhLjiTWQqEtooM3by4oY8TdoUECFLgNSFMtak1WHIqilXhb/YhN6RzEdDHXJlo7pQfm/txwWRNb1o2xRFhNfiAf9jdecR8W+bW5Ypf2jmbmBTql6Y3iFSVmERrGgkffiAKNN0PczrJ3ZYk7lnlpuwRQuODQGiCY6H9gMIje1SSKWkAxCUmgxHfqLmXh2JZkmSpo5AKKyygTknneAVJyZ12gdZYngP/OY76HKuIwrloMFaiaWuHbH6oq6XuVFYBn89uagkw2zCC7KZSOnjWsl6u9ui6rrYanKIavvKTU+9yeG6bSHIr4gXWFXfNudd1W2e1sAFbJ5cLM4sqevKOOa+09eKaHKS3Zpsrvf9aIF5Dsi2sZ0//cWdbxuQ13C51+Sbq28SvxprcN0y1XGTN4VaKXMcMh0XSFB71w1hyQV/TzlTqwkusw+5erLTEX0AY5KQ4G4qxsFW7OR50PP8iJFRbQZbsLoU1EM4qLUIrqMqENm310y7PNe2U+Orb8qvaTpdF12svnVQIeIwk9Zk0prTS1G2m7HfbLCd3gqOU5qSLU/dCvMhQ6C08Nh0Kjp08qdZPQdInVTkNg1gFJCUtluqIF6ws23Y9rFHORlQhm8y008rXFJJkffvoUngtJARnO7vCMnO6U1TywA3dpOwnUVq79D+wDkCKcnz+M4tkHcmO2FxY4BgrVmxn/ANnR5ImJM5TgEv7ndDSyynPzU/+/DRNkP4rIuyDSBv5a4kvltKLAPLCfhdQ0BnSMIA12OF8VnggHhi4h1W0TxAY3EUaUrHBDGLgbMfCHT+ChQTmefCEKCRDyNTnAQMpJoApjKEMn5ASSJwBByxwARBiYMIZ+vCHQAyiEIdIxCIa8Yg4SAAAOw==',</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                encoding: 'base64',</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                cid: 'source@app.fieldguide.com'</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            }]</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">        var transport = this.getTransport();</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">        return transport.sendMail(messageData, function(err, message){</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">            // console.log('sent message to', message);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">    mail.prototype.getTransport = function() {</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        return nodemailer.createTransport({</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                service: 'Mandrill',</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                auth: {</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                    user: 'mandrill@fieldguideapp.com',</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                    pass: app.locals.mandrillSecret</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                host: &quot;smtp.mandrillapp.com&quot;,</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                port: 587</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">    mail.prototype.getHtml = function(templateName, message_variables) {</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">        var encoding, templateContent, templatePath;</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">        templatePath = &quot;./server/views/emails/&quot; + templateName + &quot;.html&quot;;</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">        templateContent = fs.readFileSync(templatePath, encoding = &quot;utf8&quot;);</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">        return _.template(templateContent, message_variables, {</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">            interpolate: /\{\{(.+?)\}\}/g</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    // mail.prototype.getAttachments = function(html) {</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    //     var attachment, attachments, _i, _len, _ref;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    //     attachments = [];</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    //     _ref = this.attachments;</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">    //     for (_i = 0, _len = _ref.length; _i &lt; _len; _i++) {</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    //         attachment = _ref[_i];</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    //         if (html.search(&quot;cid:&quot; + attachment.cid) &gt; -1) {</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    //             attachments.push(attachment);</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    //         }</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    //     }</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">    //     return attachments;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    // };</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">  </td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">    return mail;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">})();</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">93</td><td class="hits">1</td><td class="source">var exports = module.exports = Emailer;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes.js</h2><div id="stats" class="medium"><div class="percentage">51%</div><div class="sloc">111</div><div class="hits">57</div><div class="misses">54</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// routes.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">module.exports = function(app, passport, debug) {</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">// CONFIGURATION =====================================================</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">// Module dependencies</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">    var mongoose = require('mongoose');  // THIS MAKES MESSAGE AGGREGATION WORK IN TEST RETURNS FOR SUMMARIES.</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var async = require('async');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">    var crypto = require('crypto');</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var bcrypt = require('bcrypt-nodejs');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _ = require('lodash');</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var nodemailer = require('nodemailer');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// various api hooks for reports</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    var Trello  = require('node-trello');</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">// load data storage models</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var Comment = require('./models/data/comment');</td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    var Message = require('./models/data/message');</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    var Task    = require('./models/data/task');</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var Test    = require('./models/data/test');</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    var Tag     = require('./models/data/tag');</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">    var Subject = require('./models/data/subject');</td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    var User    = require('./models/auth/user');</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    var Invitation = require('./models/auth/invitation');</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    // console logging</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    app.use(function(req, res, next) {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        // console.log('Something is happening.');</td></tr><tr class="hit"><td class="line">29</td><td class="hits">7</td><td class="source">        next(); // make sure we go to the next routes and don't stop here</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">// AUTH ROUTES ============================================</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">// route middleware to ensure user is logged in - ajax get</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    function isLoggedInAjax(req, res, next) {</td></tr><tr class="hit"><td class="line">35</td><td class="hits">3</td><td class="source">        if (!req.isAuthenticated()) {</td></tr><tr class="hit"><td class="line">36</td><td class="hits">3</td><td class="source">            return res.send( 401, &quot;unauthorized request&quot;);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        } else {</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            // console.log('login good');</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">            next();</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">// route middleware to ensure user is logged in</td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">    function isLoggedIn(req, res, next) {</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">        if (req.isAuthenticated()){</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">            return next();</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">// LOGIN ROUTES ===========================================</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    // is someone logged in?</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">    app.get('/loggedin', function(req, res) {</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            // console.log('check me for things', req.user);</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">            if(req.user){</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">                if (req.isAuthenticated()) { </td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">                    res.json({ </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                        _id : req.user._id, </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                        name: req.user.name, </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                        onboard : req.user.onboard,</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                        email: req.user.local.email, </td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                        account:req.user._account, </td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                        trello : req.user.trello.id </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">            else { res.send('0'); }</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    // who's logged in?</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">    app.get('/auth/login', isLoggedInAjax, function(req, res) {</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">            return res.json(req.user._id);</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    // process the login form</td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">    app.post('/auth/login', function(req, res, next) {</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        if (!req.body.email || !req.body.password) {</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">            return res.json({ error: 'Email and Password required' });</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">        passport.authenticate('local-login', function(err, user) {</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">            if (err) { return res.json(err); }</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">            if (user.error) { return res.json({ error: user.error }); }</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">            req.logIn(user, function(err) {</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                if (err) { return res.json(err); }</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">                console.log('login result', user);</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                res.json({ 'user': mongoose.Types.ObjectId(req.user._id),  'name':req.user.name, redirect: '/overview', msg:'login worked' });</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        })(req, res);</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">95</td><td class="hits">1</td><td class="source">    app.post('/auth/logout', function(req, res) {</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">        req.logout();</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">        res.json({ redirect: '/login' });</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">    // process the signup form</td></tr><tr class="hit"><td class="line">102</td><td class="hits">1</td><td class="source">    app.post('/auth/signup', function(req, res) {</td></tr><tr class="hit"><td class="line">103</td><td class="hits">4</td><td class="source">        console.log(req.body);</td></tr><tr class="hit"><td class="line">104</td><td class="hits">4</td><td class="source">        if (!req.body.email || !req.body.password) {</td></tr><tr class="hit"><td class="line">105</td><td class="hits">1</td><td class="source">            return res.json({ error: 'Email and Password required' });</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">107</td><td class="hits">3</td><td class="source">        passport.authenticate('local-signup', function(err, reply) {</td></tr><tr class="hit"><td class="line">108</td><td class="hits">3</td><td class="source">            if (err) { console.log(err); }</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">110</td><td class="hits">3</td><td class="source">            if(reply.user){</td></tr><tr class="hit"><td class="line">111</td><td class="hits">2</td><td class="source">                req.logIn(reply.user, function(err) {</td></tr><tr class="hit"><td class="line">112</td><td class="hits">2</td><td class="source">                    if (err) { return res.json(err); }</td></tr><tr class="hit"><td class="line">113</td><td class="hits">2</td><td class="source">                    res.json({ </td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                        'user' : reply.user._id,</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                        '_account' : reply.user._account,</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                        'email': reply.user.local.email, </td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                        'name' : reply.user.name,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                        'msg'  : 'register user worked',</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                        'redirect'   : '/overview',</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                        'onboarding' : reply.user.onboarding </td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">125</td><td class="hits">1</td><td class="source">                res.json(reply);</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">        })(req, res);</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">// PASSWORD RESET ROUTES ==================================</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">    // forgotten passwords</td></tr><tr class="hit"><td class="line">133</td><td class="hits">1</td><td class="source">    app.post('/auth/forgot', function(req, res, next) {</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">        var forgotPassword = global.rootRequire('./server/models/functions/forgot-password-token');</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="source">        forgotPassword( req.body.email, app, function(err, password){</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">            res.send(passport);</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    // password reset route</td></tr><tr class="hit"><td class="line">142</td><td class="hits">1</td><td class="source">    app.get('/reset/:token', function(req, res) {</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">        console.log('check reset');</td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="source">        User.findOne({ resetPasswordToken: req.params.token, resetPasswordExpires: { $gt: Date.now() } }, function(err, user) {</td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">            if (!user) { res.send('0'); }</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">            res.send('1');</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">    // password reset route</td></tr><tr class="hit"><td class="line">151</td><td class="hits">1</td><td class="source">    app.post('/reset/:token', function(req, res) {</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">        console.log('password reset queued');</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">        var resetPassword = global.rootRequire('./server/models/functions/reset-lost-password');</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">        resetPassword(req.params.token, req.body.password, app, function(err, pass){</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">            res.send(pass);</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">// PUBLIC ROUTES ==========================================</td></tr><tr class="hit"><td class="line">163</td><td class="hits">1</td><td class="source">    app.route('/auth/invite/:_id')</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">        .get(function(req,res){</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">            // get an existing invitation to populate the registration page</td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">            Invitation.findById(req.params._id)</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                .select('invite_email')</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                .exec(function(err,invite){</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">                    if(err) { return console.log(err); }</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">                    </td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">                    res.json(invite);</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">// Debug Routes -------------------</td></tr><tr class="hit"><td class="line">176</td><td class="hits">1</td><td class="source">    app.route('/debug/message')</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">        .put(function(req, res){</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">            var connectionOne = require('./models/app-connect');</td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="source">            var Msg = connectionOne.model('Message');</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="source">            Msg.create({body: 'new message test'}, function(err, update){</td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="source">                console.log(update);</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">    // app.route('/debug/test')</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">    // .get(function(req,res){</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">    //     Test.find()</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">    //         .exec(function(err, docs) {</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">    //             if(err){console.log(err);}</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">    //             res.json(docs);</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">    //         });</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">    // app.route('/debug/comment')</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">    // .get(function(req,res){</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">    //     Comment.find()</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">    //         .exec(function(err, docs) {</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">    //             if(err){console.log(err);}</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">    //             res.json(docs);</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">    //         });</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">    // app.route('/debug/test/:_id')</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">    // .get(function(req,res){</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">    //     Test.find({'_id': req.params._id})</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">    //         .populate('_tasks')</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">    //         .exec(function(err, docs) {</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">    //             if(err){console.log(err);}</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">    //             res.json(docs);</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    //         });</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">    // });    </td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">    // app.route('/debug/task')</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">    // .get(function(req,res){</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">    //     Task.find()</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">    //         .exec(function(err, docs) {</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">    //             if(err){console.log(err);}</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">    //             res.json(docs);</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">    //         });</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">    // app.route('/debug/message')</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">    // .get(function(req,res){</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">    //     Message.find()</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">    //         .populate('_comments')</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">    //         .exec(function(err, docs) {</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">    //             if(err){console.log(err);}</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">    //             res.json(docs);</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">    //         });</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">    // app.route('/debug/tag')</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">    //     .get(function(req,res){</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">    //         Tag.find(function(err, docs) {</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">    //                 if(err){console.log(err);}</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">    //                 res.json(docs);</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">    //             });</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">    //     });</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">    // app.route('/debug/user')</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">    //     .get(function(req,res){</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">    //         User.find(function(err, users) {</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">    //                 if(err){console.log(err);}</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">    //                 res.json(users);</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">    //             });</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">    //     });</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">    // app.route('/debug/invite')</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">    //     .get(function(req,res){</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">    //         Invitation.find(function(err, invites) {</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">    //                 if(err){console.log(err);}</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">    //                 res.json(invites);</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">    //             });</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">    //     });</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">    // app.route('/debug/subject')</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">    //     .get(function(req,res){</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">    //         Subject.find()</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">    //             .exec(function(err, docs) {</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">    //                 if(err){console.log(err);}</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">    //                 res.json(docs);</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">    //             });</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">    //     });</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">// ACCOUNT EXPORT ROUTE ===================================</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">// Again, this simply breaks as a Require rather than a direct route. </td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">//  \_()_/</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">    // require('./routes/account_export')(app);</td></tr><tr class="hit"><td class="line">283</td><td class="hits">1</td><td class="source">    app.route('/auth/export/account/')</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">        .get(function(req,res){</td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">            var accountExporter = require('./models/functions/account_export');</td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="source">            accountExporter(req.user._account, function(err, account) {</td></tr><tr class="miss"><td class="line">287</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="source">                res.json(account);</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">// PUBLIC REPORT ROUTE ==============================================</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">// for some reason I can't require this and still have it be public</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">//  \_()_/</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">297</td><td class="hits">1</td><td class="source">    app.route('/api/public/report/:_id')</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">    .get(function(req, res){</td></tr><tr class="miss"><td class="line">299</td><td class="hits">0</td><td class="source">        var buildSummary = global.rootRequire('./server/models/functions/build-summary');</td></tr><tr class="miss"><td class="line">300</td><td class="hits">0</td><td class="source">        buildSummary(req.params._id, function(err, summary){</td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="source">            res.json(summary);</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">// MIDDLEWARE TO BLOCK NON-AUTHORIZED USERS ===============</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">// this effectively prevents unlogged users from getting data</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">309</td><td class="hits">1</td><td class="source">    app.use('/api',  isLoggedInAjax, function (req, res, next) {</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">        // for calls that start with api....</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">        // console.log('touched the api tag');</td></tr><tr class="miss"><td class="line">312</td><td class="hits">0</td><td class="source">        next();</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">// CONNECT ROUTES =========================================</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">318</td><td class="hits">1</td><td class="source">    app.get('/connect/trello',</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">        passport.authorize('trello-authz', { failureRedirect: '/account' })</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">        // ,function(req, res) {</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">        //     res.send({trello : true});</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">        );</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">326</td><td class="hits">1</td><td class="source">    app.get('/connect/trello/callback',</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">      passport.authorize('trello-authz', { failureRedirect: '/account' }),</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">      function(req, res) {</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">        // this sends things to the popup window.</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">        // var script = '$scope.parentWindow = window.opener.$windowScope;</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">        //              console.log($scope.connector);';</td></tr><tr class="miss"><td class="line">332</td><td class="hits">0</td><td class="source">        res.send('&lt;html&gt;&lt;head&gt;&lt;script&gt;window.opener.inviteCallback(); window.close();&lt;/script&gt;'+</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source">                '&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Thanks for attaching your account.&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;');</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">336</td><td class="hits">1</td><td class="source">    app.delete('/connect/trello', function(req, res){</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">        // console.log(req.body);</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">339</td><td class="hits">0</td><td class="source">        req.user.trello.id = '';</td></tr><tr class="miss"><td class="line">340</td><td class="hits">0</td><td class="source">        req.user.trello.token = '';</td></tr><tr class="miss"><td class="line">341</td><td class="hits">0</td><td class="source">        req.user.trello.tokenSecret = '';</td></tr><tr class="miss"><td class="line">342</td><td class="hits">0</td><td class="source">        req.user.save();</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">344</td><td class="hits">0</td><td class="source">        res.json({trello : false});</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">// ACCOUNT ROUTES =========================================</td></tr><tr class="hit"><td class="line">348</td><td class="hits">1</td><td class="source">    require('./routes/account')(app, debug);</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">// ONBOARDING ROUTES ======================================</td></tr><tr class="hit"><td class="line">351</td><td class="hits">1</td><td class="source">    require('./routes/user')(app, passport);</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">// OBJECT ROUTES ==========================================</td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">// Session Routes</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">    // require('./routes/session')(app, debug);</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">// Test Routes</td></tr><tr class="hit"><td class="line">359</td><td class="hits">1</td><td class="source">    require('./routes/test')(app, debug);</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">// Task Routes </td></tr><tr class="hit"><td class="line">362</td><td class="hits">1</td><td class="source">    require('./routes/task')(app, debug);</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">// Task Routes </td></tr><tr class="hit"><td class="line">365</td><td class="hits">1</td><td class="source">    require('./routes/message')(app, debug);</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">// Tag Routes</td></tr><tr class="hit"><td class="line">368</td><td class="hits">1</td><td class="source">    require('./routes/tag')(app, debug);</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">// Subject Routes</td></tr><tr class="hit"><td class="line">371</td><td class="hits">1</td><td class="source">    require('./routes/subject')(app, debug);</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">// LIVE ROUTES ============================================</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">// Run A Test</td></tr><tr class="hit"><td class="line">377</td><td class="hits">1</td><td class="source">    require('./routes/run')(app, debug);</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source">// Do A Summary</td></tr><tr class="hit"><td class="line">380</td><td class="hits">1</td><td class="source">    require('./routes/summary')(app, debug);</td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/account.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/account.js</h2><div id="stats" class="low"><div class="percentage">35%</div><div class="sloc">40</div><div class="hits">14</div><div class="misses">26</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// /routes/account.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">// ACCOUNT AND INVITATION ROUTES =========================================</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">module.exports = function(app, debug){</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var mongoose = require('mongoose');  // Permits use of ObjectID type</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _        = require('lodash');</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var async    = require('async');</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var Promise  = require('bluebird');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">// Load models ==================================</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var User        = global.rootRequire('./server/models/auth/user');</td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var Invitation  = global.rootRequire('./server/models/auth/invitation');</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var Emailer     = global.rootRequire('./server/models/mailer');</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">// Load functions ===============================</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var createInvite = global.rootRequire('./server/models/functions/create-invite');</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    var resendInvite = global.rootRequire('./server/models/functions/resend-invite');</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">// INVITATION ROUTES ======================================</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    app.route('/api/account/:_user')</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        .get(function(req,res){</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        // if there's a user, get a user</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        // if there's an account, get the users attached to that account</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">            var getUser =  mongoose.Types.ObjectId(req.params._user);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">            var reply = {};</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">            var promise = </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                User.findById(getUser).exec();</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">            promise.then(function(user){</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                            </td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">                reply.id = user._id;</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">                reply.email = user.local.email;</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">                reply.name = user.name;</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                reply.account = user._account;</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">                reply.trello = false;</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                if (user.trello.id){ reply.trello = true; }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                return User.find({_account: user._account}).select('local.email name _account').exec();</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            .then(function(team_members){</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">                reply.team = team_members;</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">                return Invitation.find({_account: reply.account, pending: true}).exec();</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">            .then(function(invites){</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                reply.invites = invites;</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">                res.json(reply);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            .then(null, function(err){</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">                if(err) {return res.send (err);}</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        // .delete(function(req,res){</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        //     console.log('touched delete user');</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        //     User.remove({'_id' : req.params._user}, function(err, doc){</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        //         if(err) {return res.send (err);}</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        //         res.json('User removed');</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    // INVITATION ROUTES ==================================</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">    app.route('/api/invite/')</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        .post(function(req,res){</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">            // create a new invitation</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">            createInvite(req.body, req.user, function(err, invite){</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">                res.json(invite);</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">    app.route('/api/invite/:_id')</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        .put(function(req,res){</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">            console.log('invite put');</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        .post(function(req,res){</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            // this is to resend an invitation already sent</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">            resendInvite(req.params._id, req.user, function(err, invite){</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                res.json(invite);</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        .delete(function(req,res){</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">            Invitation.remove({'_id': req.params._id}, function(err, invite){</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">                if(err) {return console.log (err);}</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">                res.json('Invitation recalled');</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/message.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/message.js</h2><div id="stats" class="medium"><div class="percentage">58%</div><div class="sloc">31</div><div class="hits">18</div><div class="misses">13</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">//message.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(app, passport, debug) {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var mongoose = require('mongoose');  // can't set an ObjectID without this.</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">    var _ = require('lodash');</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var async = require('async');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var Promise = require('bluebird');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">// load functions  ==============================</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var newMessage     = global.rootRequire('./server/models/functions/new-message.js');</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    var messageFav = global.rootRequire('./server/models/functions/message-fav');</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">    var buildMsgList   = global.rootRequire('./server/models/functions/messages-list');</td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    var editMsg        = global.rootRequire('./server/models/functions/edit-message.js');</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">//MESSAGE ROUTES  ================================================</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> // Message Routes from Summary ===========================</td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    app.route('/api/message/')</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    .get(function(req,res){</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        // return all messages in the system. This is too many messages.</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        // TODO: get all messages by current user?</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        // Get all messages for current user account?</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        // Messages don't store their account, because they're a User's creation. Bad?</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        // Message.find({})</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        //     .exec(function(err, messages) {</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        //         if(err){ console.log(err); }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        //         res.json(messages);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    .post(function(req,res){</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">     // Create a new message</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">        newMessage(req.body, req.user._id, function(err, message){</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                res.json(message);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    .put(function(req, res){</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    // Edit the body of a message and change its tag associations</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">        editMsg(req.body, function(err, msg){</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">            res.json(msg);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">    app.route('/api/message/fav')</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">   .put(function(req, res){</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    // post fav to a message or array of messages</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">        var message_array = [req.body];</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">        messageFav(message_array, function(err, messages){</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">            res.json(messages);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">    app.route('/api/message/:_id')</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    .get(function(req,res){</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        //get one specific message</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">        Message.findById(req.params._id)</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            .exec(function(err,msg){</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">                if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">                res.json(msg);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/run.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/run.js</h2><div id="stats" class="medium"><div class="percentage">66%</div><div class="sloc">18</div><div class="hits">12</div><div class="misses">6</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// run.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(app, passport, io, debug) {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies ====================================</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var async = require('async');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// load data storage models ===============================</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var Message = global.rootRequire('./server/models/data/message');</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    var Tag     = global.rootRequire('./server/models/data/tag');</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">// load functions ========================================= </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var newMessage = global.rootRequire('./server/models/functions/new-message.js');</td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    var objectUpdates  = global.rootRequire('./server/models/functions/object-updates');</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">// RUN ROUTES =============================================</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    app.route('/api/run/')</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        .get(function(req,res){</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        .post(function(req,res){</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            // req.body should be an array of objects on DB to be updated.</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">            objectUpdates(req.body, function(err, next){</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">                if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">                res.json('completed', next);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    app.route('/api/run/:_id')</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        .get(function(req,res){</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            // Find a test by _id and _account and populate its tasks, then return.</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">            Test.findOne({</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                    '_id' : req.params._id, </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                    '_tasks': {$not: {$size: 0}}, </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                    'created_by_account' : req.user._account </td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                .populate('_tasks')</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                .exec(function(err, docs){</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                    res.json(docs);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/subject.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/subject.js</h2><div id="stats" class="low"><div class="percentage">37%</div><div class="sloc">16</div><div class="hits">6</div><div class="misses">10</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// subject.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(app, passport, debug) {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var Subject = global.rootRequire('./server/models/data/subject');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// load functions ===============================</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var addSubject = global.rootRequire('./server/models/functions/add-subject');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// SUBJECT ROUTES ===============================================</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    app.route('/api/subject/')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        .get(function(req,res){</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">                Subject.find({})</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">                    .exec(function(err,subjects){</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">                        if(err){console.log(err);}</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">                        </td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">                        res.json(subjects);</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        .post(function(req,res){</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">                addSubject(req.body, function(err, subject){</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">                    if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">                    console.log(subject);</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">                    res.json(subject);</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    app.route('/api/subject/:_id')</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        .get(function(req, res){</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">            Subject.findById(req.params._id)</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                .exec(function(err, subject){</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">                    res.json(subject);</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/summary.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/summary.js</h2><div id="stats" class="low"><div class="percentage">29%</div><div class="sloc">31</div><div class="hits">9</div><div class="misses">22</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// summary.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function (app, passport, debug) {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var async = require('async');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// load functions ===============================</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var buildSummary   = global.rootRequire('./server/models/functions/build-summary');</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var objectUpdates  = global.rootRequire('./server/models/functions/object-updates');</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var messageFav     = global.rootRequire('./server/models/functions/message-fav');</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    var newComment     = global.rootRequire('./server/models/functions/comment');    </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">// SUMMARY ROUTES ============================================</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    app.route('/api/summary/:_id')</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    .get(function(req, res){</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    // get the navigation console for the summary.</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">        buildSummary(req.params._id, function(err, summary){</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">            if(err){ console.log(err); }</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            // console.log('summary', summary);</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">            res.json(summary);</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    .put(function(req, res){</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        // this should be used for updating objects with</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        // visibility and summaries</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">        console.log('object update this steeze', req.body);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">        var object_array = req.body.navlist || req.body;</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        var message_array = req.body.messages || [];</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">        async.parallel([</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            function(callback){</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">                objectUpdates(object_array,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                function(err, update){</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                    callback(null, update);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">            function(callback){</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                messageFav(message_array,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                    function(err, update){</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                        if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">                        callback(null, update);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        function(err,results){</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">            res.json(results);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    .post(function(req,res){</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        // update an object but not any messages</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        console.log('solo update', req.body);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">        objectUpdates(req.body,</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            function(err, update){</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">                res.json(update);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">    // Comment route =============================</td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">    app.route('/api/comment/')</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">       .post(function(req, res){</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        // Add a comment to a message declared on the request.</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">        newComment(req.body, req.user, function(err, comment){</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">            res.json(comment);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/tag.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/tag.js</h2><div id="stats" class="low"><div class="percentage">41%</div><div class="sloc">12</div><div class="hits">5</div><div class="misses">7</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// tag.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(app, passport, debug) {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var Tag     = require('../models/data/tag');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// TAG ROUTES ================================================</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    app.route('/api/tag/')</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        .get(function(req,res){</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">            Tag.find(function(err, tags) {</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">                    res.json(tags);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    app.route('/api/tag/:_id')</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        .get(function(req,res){</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">            Tag.findById(req.params._id)</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">                .exec(function(err, tags) {</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">                    if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">                    res.json(tags);</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        .post(function(req,res){</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            // console.log('tag post touched')</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">            res.json('tag post touched');</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/task.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/task.js</h2><div id="stats" class="low"><div class="percentage">29%</div><div class="sloc">31</div><div class="hits">9</div><div class="misses">22</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// task.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(app, passport, debug) {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies ==========================</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var async    = require('async');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// load data storage models =====================</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var Task    = global.rootRequire('./server/models/data/task');</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// load functions ===============================</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    var deleteTask     = global.rootRequire('./server/models/functions/delete-task.js');</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var objectUpdates  = global.rootRequire('./server/models/functions/object-updates');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">// TASK ROUTES ===================================================</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    app.route('/api/task/')</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    // get all tasks</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    .get(function(req,res){</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        Task.find({}, </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            function(err, tasks) {</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">                if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">                res.json(tasks);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    .put(function(req,res){</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        // update an array of tasks</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">        var arr = _.toArray(req.body);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        objectUpdates(arr, function(err, update){</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">            res.json(update);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    .post(function(req,res){</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        // Create a new task and push it to a test.</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        // TODO: This relies on a dual pointer. We should remove that shit.</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">        Task.create({</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">            name : req.body.name,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            desc : req.body.desc,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            _test : req.body._test,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            index : req.body.index</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        }, function(err, task){</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">            if(err){ console.log(err); }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">            Test.findOneAndUpdate(</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                { '_id' : task._test},</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                { $push: { '_tasks' : task._id} },</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                { upsert : false },</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                function(err, test){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                    if (err) { console.log(err); }</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">                    res.json(task);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">    app.route('/api/task/:_id')</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    .get(function(req,res){</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    // get single task</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">        Task.findById(req.params._id)</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            .exec(function(err,task){</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                res.json(task);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    .put(function(req,res){</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    // update a single task</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">        var arr = [req.body];</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">        objectUpdates(arr, function(err, update){</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">            res.json(update);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    .delete(function(req,res){</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    // delete a task</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">        deleteTask(req.params._id, function(err, task){</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">            res.json(task);</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/test.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/test.js</h2><div id="stats" class="low"><div class="percentage">35%</div><div class="sloc">31</div><div class="hits">11</div><div class="misses">20</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// test.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(app, passport, debug) {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Module dependencies</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var async = require('async');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// load data storage models</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var Test    = global.rootRequire('./server/models/data/test');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">// load functions</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    var devTest  = global.rootRequire('./server/models/functions/dev-tests');</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    var dupeTest = global.rootRequire('./server/models/functions/dupe-tests');</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var editTest = global.rootRequire('./server/models/functions/edit-test');</td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var delTest  = global.rootRequire('./server/models/functions/delete-test');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">// TEST ROUTES ===================================================</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    app.route('/api/test/')</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    .get(function(req,res){</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    // get all of the tests</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        Test.find({created_by_account:req.user._account})</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        .exec(function(err, docs) {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">            res.json(docs);</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    .post(function(req,res){</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">        console.log('touched New Test', req.user);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    // add a new test</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        Test.create({</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            created_by_account : req.user._account,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            created_by_user : req.user._id</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        }, function(err, test){</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">            res.json(test);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">    app.route('/api/dev_tests/')</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    .post(function(req, res){</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    // This builds a mock for testing reports</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">        devTest(req.user._account, req.user._id, function(err, test){</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">            res.json(test);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">    app.route('/api/test/:_id')</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    .get(function(req,res){</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    // get one test</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        Test.findById(req.params._id)</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">            .populate('_tasks')</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            .exec(function(err,test){</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                res.json(test);</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    .post(function(req,res){</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">    // Duplicate a test with new steps and things but which appears to be identical</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">        dupeTest(req.params._id, function(err, test){</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">            res.json(test);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">    .put(function(req,res){</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">    // update one test with new information</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">        editTest(req.body, function(err, test){</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">            if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">            res.json(test);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    .delete(function(req,res){</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    // Delete a test and dependencies</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">        delTest(req.params._id, function(err, test){</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">            if(err){ console.log(err); }</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">            res.json(test);</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/routes/user.js">/Users/alexleitch/Documents/Heist/scout-dev/server/routes/user.js</h2><div id="stats" class="low"><div class="percentage">26%</div><div class="sloc">15</div><div class="hits">4</div><div class="misses">11</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// onboarding and user models</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// user.js</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">'user strict';</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">module.exports = function(app, passport) {</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var User = global.rootRequire('./server/models/auth/user');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">app.route('/api/user/:_id')</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    .get(function(req,res){</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    .put(function(req,res){</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">        User.findOne({'_id' : req.user._id})</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">                if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">                if(user){</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">                    console.log('req.body.onboard', user.onboard, req.body);</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">                    user.onboard = req.body.onboard;</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">                    user.save(function(err, data){</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">                        if(err){console.log(err);}</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">                        console.log('user onboard', user.onboard);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">                        res.send('saved');</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                else {</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">                    console.log('user not found');</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">                    res.send('user not found');</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/alexleitch/Documents/Heist/scout-dev/server/socket_routes_09.js">/Users/alexleitch/Documents/Heist/scout-dev/server/socket_routes_09.js</h2><div id="stats" class="low"><div class="percentage">25%</div><div class="sloc">71</div><div class="hits">18</div><div class="misses">53</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// socket_routes_1.js</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">module.exports = function(io, app, passport, debug) {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">    // MODULES ============================================</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">    var cookie = require('cookie'),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        cookieParser = require('cookie-parser'),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        crypto = require('crypto'),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        passportSocketIo = require('passport.socketio'),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        _ = require('lodash');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    // LOCAL GLOBALS ======================================</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    var user = {},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        socketData = {},</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        name = '',</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        default_room = '';</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    // MODELS =============================================</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    var Test = require('./models/data/test');</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    // var secrets = require(path.join(__dirname,'secrets'));</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    // AUTHENTICATION VIA PASSPORT ========================</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    io.configure(function () {</td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">        io.set('authorization', passportSocketIo.authorize({</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            cookieParser: cookieParser,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            key:         'connect.sid',       // the name of the cookie where express/connect stores its session_id</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            secret:      app.locals.secret,    // the session_secret to parse the cookie</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            store:       app.locals.store,        // we NEED to use a sessionstore. no memorystore please</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            success:     onAuthorizeSuccess,  // *optional* callback on success - read more below</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            fail:        onAuthorizeFail,     // *optional* callback on fail/error - read more below</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        }));</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">    function onAuthorizeSuccess(data, accept){</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        // Passport has heard of them ===========</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">        console.log('authwin socket connection info', data.query.test);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">        user = data.user;</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">        name = data.user.name;</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">        userNames.claim(name);</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">        default_room = data.query.test;</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">        accept(null, true);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">    function onAuthorizeFail(data, message, error, accept){</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        // Assumed to be a guest user ===========</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">        if(error){ console.log(error);}</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">        console.log('failed connection to socket.io:', message);</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        console.log('authfail socket connection info', data.query.test, default_room);</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        name = userNames.getGuestName();</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        default_room = data.query.test;</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">        accept(null, true);</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        // accept();</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        // If they are not a guest user =========</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        // accept(new Error(message));</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        // this error will be sent to the user as a special error-package</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        // see: http://socket.io/docs/client-api/#socket &gt; error-object</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">// CONNECT TO THE SOCKETS ===========================================</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">// ROOM REGISTRATION BASED ON CONNECTION QUERYSTRING ============</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    // http://blog.seafuj.com/migrating-to-socketio-1-0</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    // SOCKET 0.9 VARIANT</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">1</td><td class="source">    var roomList = [];</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">// FIRE IT UP =======================================================</td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">    io.sockets.on('connection', function (socket) {</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">        console.log('hello user', user._account);</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">        console.log('someone connected from somewhere');</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">        var k = '';</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">        socket.on('message', function(msg, err){</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            // if there's no channel, emit the message that there's no channel? IDK.</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            // console.log('message arrived!', msg, err);</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">            k = Object.keys(io.sockets.manager.roomClients[socket.id]);</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">            if (k[1] !== undefined) {</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">                var chan = k[1].substring(1, k[1].length);</td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">                socket.broadcast.to(chan).emit('message', msg);                </td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        // subscription is used in the iOS app</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">        socket.on('subscribe', function(data) { </td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">            console.log('subscription arrived', data);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">            var hash = crypto.createHash('md5').update(data.room).digest('hex').substring(0, 8).toLowerCase();</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">            console.log('joining room hash', hash);</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">            k = Object.keys(io.sockets.manager.roomClients[socket.id]);</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">            socket.join(hash); </td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        // channel or join_room are used by the web app</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">        socket.on('channel', function(data) { </td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">            console.log('joining channel', data.room, data.test, data);</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">            var promise = Test.findOne({'_id': data.test})</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                              .select(&quot;name link&quot;)</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                              .exec();</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                              </td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">            promise.then(function(test){</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                // joins the test to the socket from remote device</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                // console.log('Test found', test);</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">                socket.join(data.room);</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                // passes the phone the route for getting the appropriate test from the socket</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">                io.sockets.in(data.room).emit('joinedChannel', {data: {body: test.link, title:test.name}});</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="source">        socket.on('join_room', function(data) { </td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">            console.log('joining room', data.room.toLowerCase());</td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">            socket.join(data.room);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">        socket.on('testComplete', function(data){</td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">            console.log('testComplete', data.data.room);</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">            io.sockets.in(data.data.room).emit('endTest', data.data.body);</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">// Guest name management ============================================</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    // Keep track of which names are used so that there are no duplicates</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">141</td><td class="hits">1</td><td class="source">    var userNames = (function () {</td></tr><tr class="hit"><td class="line">142</td><td class="hits">1</td><td class="source">            var names = {};</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">144</td><td class="hits">1</td><td class="source">            var claim = function (name) {</td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">                if (!name || names[name]) {</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">                    return false;</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">                    names[name] = true;</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">                    return true;</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">            // find the lowest unused &quot;guest&quot; name and claim it</td></tr><tr class="hit"><td class="line">154</td><td class="hits">1</td><td class="source">            var getGuestName = function () {</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">                var name,</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">                    nextUserId = 1;</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="source">                do {</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                    name = 'Guest ' + nextUserId;</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">                    nextUserId += 1;</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">                } while (!claim(name));</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="source">                return name;</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">            // serialize claimed names as an array</td></tr><tr class="hit"><td class="line">167</td><td class="hits">1</td><td class="source">            var get = function () {</td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">                var res = [];</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">                for (var user in names) {</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                    res.push(user);</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                return res;</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">176</td><td class="hits">1</td><td class="source">            var free = function (name) {</td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">                if (names[name]) {</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">                    delete names[name];</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">182</td><td class="hits">1</td><td class="source">            return {</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                claim: claim,</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                free: free,</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                get: get,</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                getGuestName: getGuestName</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">        }());</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div></div></div></body></html>